---

title: Methods and apparatus for managing virtual ports and logical units on storage systems
abstract: A storage system configured to associate a virtual port  to a plurality of physical ports . In response to commands from computers, the storage system  manages relation between physical ports and virtual ports and relation between virtual port and volumes by performing processes such as creating a virtual port, assigning LUs to a virtual port, moving a virtual port between physical ports and deleting a virtual port. The storage system also maintains/calculates statistics information for ports and displays the information for each virtual port.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08364869&OS=08364869&RS=08364869
owner: Hitachi, Ltd.
number: 08364869
owner_city: Tokyo
owner_country: JP
publication_date: 20120821
---
This is a continuation of U.S. patent application Ser. No. 12 569 453 filed Sep. 29 2009 now U.S. Pat. No. 8 260 986 the entire disclosure of which is incorporated herein by reference.

This invention is related to method and apparatus to manage virtual ports logical units and statistics information regarding the virtual ports on storage systems.

SAN switches implement zoning among plurality of ports and make one or more exclusive portions of network by referring name service i.e. name list held in the switch. World Wide Port Name WWPN an unique identifier assigned to a port in a Fibre Channel FC Fabric could be used for zone control. Fibre Channel is one type of protocol specification for storage area network SAN that is network to connect servers i.e. host computers and storage systems. Recent development of the N Port ID Virtualization NPIV technique allows multiple N Port IDs to share a single physical N Port in a FC or Fibre Channel over Ethernet FCoE facility. This allows transferability of virtual ports as described in US 2009 0025007A1.

In order to manage a plurality of virtual ports in information systems relationships between the physical ports logical units on the storage systems needs to be managed and maintained by the storage system.

Exemplary embodiments of the invention provide a system where a plurality of physical ports are allocated to one virtual port. This allows the host to access logical volumes allocated to different physical ports selectively via a common virtual port. Also when many to many relationship between physical ports and virtual ports is generated statistics information regarding the network and ports also should be monitored maintained and analyzed in perspective of each virtual port.

In one embodiment a storage system includes a first and second physical port to receive I O operations from a host computer a first and second logical volume coupled to the first physical port and a storage controller including a memory and a processor where the host computer is able to access both first and second physical port via a first virtual port in response to a write command to be written to the first logical volume from the host computer the storage controller controls data to be transferred to the first logical volume via the first physical port based on relations between a first virtual port identifier and the first volume number and in response to a write command to be written to the second logical volume from the host computer the storage controller controls data to be transferred to the second logical volume via the second physical port based on relations between a first virtual port identifier and the second volume number.

In this embodiment each physical port possesses a plurality of virtual ports having WWPN which may be assigned by the user and virtual ports of the same WWPN i.e. logically one virtual port are placed on different physical ports . Virtual ports in the SAN are identified by WWPN according to the specification of FC and SAN switch which possesses zoning capability. SAN switch can make one or more exclusive portions of network i.e. zone and they are realized by referring name service i.e. name list held in the SAN switch . Each of the virtual ports stores World Wide Name WWN identification data that is unique worldwide 1 port WWN and 2 node WWN respectively each having an eight byte size. Since these virtual identifier values are unique worldwide they are capable of primarily identifying the ports and nodes in a FC network. Even though the virtual port is located on multiple physical ports it does not affect configuration and settings regarding SAN and SAN switch such as the configuration of zoning. Thus quantity of work for system replacement or data migration can be reduced with using this method.

The host and management computer are connected to the physical ports via the SAN e.g. Fibre Channel FC Fibre Channel over Ethernet FCoE . The host management computer and storage controller are connected to each other via the LAN e.g. IP network . The host has a file system an operating system OS and an application program . To execute these programs the host also has resources such as processor memory and storage devices not shown in but known in the art.

Volumes Logical Units or LUs provided by the storage system to the host computers are produced from collected areas of storage devices. The data stored may be protected by using parity code i.e. by RAID configuration or mirroring.

At step the management computer generates and sends a volume creation command to storage controller . At step the storage controller creates one or more volumes by updating volume information . During the updating process accesses to volumes from the host are prohibited.

At step the management computer generates and sends a port creation command to the storage controller . WWPN of the virtual port to be created volume and LUN to be assigned as LU to the virtual port and physical port where the virtual port is located on may be specified by the management computer in the port creation command as parameters. At step the storage controller creates one or more virtual ports by updating virtual port information in response to receiving the port creation command shows one example of virtual port information stored in the memory . The virtual port information includes ID of virtual port ID of physical port associated with a virtual port WWPN of the virtual port the number and LUN of LUs assigned to the virtual port. shows another example of the virtual port information stored in the memory . While the virtual port information is aggregated for each physical ports in this example the information is aggregated for each virtual port. Thus the number of physical ports for each virtual port would be included in this example . Virtual port information is preferred when the number of virtual ports assigned to each physical port increases in terms of table management. By using the information shown in the storage controller can manage many to many relationship between physical ports and virtual ports . At step the storage controller assigns one or more volumes as LUs to the virtual port by updating virtual port information and volume information according to the information included in the port creation command. Thus the relation between the virtual port and the LUs is set within the storage system . At step the storage controller allows access to the assigned LUs from host computer .

Several patterns of migration of virtual port and LUs can be achieved by executing the above process as described below. and show a first example of updated virtual port information as a result of a location change of virtual port . From the state shown by and virtual port ID is transferred from a physical port ID to a physical port ID . All LU associated with the virtual port ID has been moved to the target physical port to maintain the relation with the virtual port ID . Thus the LU is accessible from physical port ID after the migration as illustrated in and .

As explained above these kinds of migration regarding virtual ports can be achieved by a single type of command by changing parameters in the command from the management computer to the storage controller . However the above operations such as move merge and division may be realized by commands for each operation such as a move command a merge command and a division command

The second example illustrated in and is a case where the specified virtual port can be deleted from all the associated physical ports from the state shown by and . In this example the virtual port ID is deleted from all physical port . Virtual port information shown in describes that entry for virtual port ID is deleted compared to . Virtual port information shown in deletes the entry for virtual port ID compared to .

The first and second example for deletion of virtual ports can be achieved by a single type of command by changing parameters in the command. However the above operations may be realized by commands for each operation.

In the previous description the commands for port creation move and deletion were all sent from management computer . However the instructions may be come from management console of storage system as well.

During execution of operations using physical ports such as data read process and write process the storage controller monitors and records a variety of values regarding the processes and performance for each virtual port on each physical port in addition to ordinary monitored values regarding physical ports . Thus in the process several metrics are monitored counted and classified for each virtual port . Statistics information regarding the network and ports is monitored maintained and analyzed in perspective of each virtual port to improve performance and achieve load balancing. shows an example of physical port statistics information in the memory that maintains monitored values. In the physical port statistics information includes physical port ID virtual port ID and values such as bytes received per second bytes sent per second the number of packets sent per second the number of packets received per second the number of inbound packets of error per second the number of outbound packets of error per second queue length regarding packets and values regarding quality of service. These values can be stored in terms of maximum values minimum values and or average values for each periodical period. The periodical periods may be set by the management computer . The storage controller maintains the values aggregated calculated for each virtual port by aggregating the monitored value of each physical port for each WWPN.

With the processes described above management of many to many relationship between physical ports and virtual ports generated by using NPIV technique applied to the storage controller is achieved. And monitoring and management of statistics information from a perspective of each virtual port is realized. The information such as port configuration and statistics also can be displayed to users by management console not shown in of storage controller .

In addition to management of statistics information for each virtual port by storage controller management computer can obtain the statistics information from the storage controller via LAN and or SAN and manage the statistics information each virtual port . illustrates physical port statistics information stored in the memory of the management computer . Physical port statistics information includes storage system ID physical port ID virtual port ID and values such as bytes received per second bytes sent per second the number of packets sent per second the number of packets received per second the number of inbound packets of error per second the number of outbound packets of error per second queue length regarding packets and values regarding quality of service. Since management computer is capable of managing multiple storage systems storage system ID would be required in addition to contents of physical port statistics information for each storage controller . and show examples of statistics calculation process executed by management computer . These processes are similar to the processes shown in and . By these processes management computer also maintains virtual port statistics information that has the same items as virtual port statistics information of each storage controller . shows an example of virtual port statistics information .

Management computer also possesses physical port information virtual port information and configuration information by referring obtaining physical port information virtual port information and volume information of each storage system via LAN and or SAN . These information include configuration information of elements e.g. physical ports virtual ports and LUs volumes of one or more storage systems . While the calculated results could be send from each storage controller to the management computer aggregating the information by the management computer instead could decrease the load for the storage controllers . This is especially efficient when the number of ports increase.

The present invention provides a storage system which virtual ports can be accessed from host computers via SAN and multiple virtual ports can be placed on one physical port on the storage system while one virtual port can be located on multiple physical ports. In response to commands from computers the storage system manages relation between physical ports and virtual ports and relation between virtual port and volumes by performing processes such as creating a virtual port assigning LUs to a virtual port moving a virtual port between physical ports and deleting a virtual port. The storage system also maintains calculates statistics information regarding ports and shows it from a perspective for each virtual port. Moreover the management computer aggregates the management information and the statistics information from storage systems and shows it for each virtual port. Having described my invention however many modifications thereto will become apparent to those skilled in the art to which it pertains without deviation from the spirit of the invention as defined by the scope of the appended claims.


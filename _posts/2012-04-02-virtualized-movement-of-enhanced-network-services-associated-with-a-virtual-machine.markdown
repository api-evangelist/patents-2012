---

title: Virtualized movement of enhanced network services associated with a virtual machine
abstract: In one embodiment, a method comprises detecting an initiation of a movement process of a virtual machine executed by a first physical host to a destination physical host; initiating a transfer of a stateful process executed by a first network entity and providing enhanced network services for the virtual machine executed in the first physical host, including causing execution parameters for the enhanced network services to be sent to a second network entity; and completing the movement process of the virtual machine to the destination physical host in response to detecting the stateful process is executing in the second network entity and is ready to provide the enhanced network services for execution of the virtual machine in the destination physical host.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09116736&OS=09116736&RS=09116736
owner: Cisco Technology, Inc.
number: 09116736
owner_city: San Jose
owner_country: US
publication_date: 20120402
---
The present disclosure generally relates to virtualization technologies that enable a virtual machine to be moved dynamically from one physical server to another physical server.

This section describes approaches that could be employed but are not necessarily approaches that have been previously conceived or employed. Hence unless explicitly specified otherwise any approaches described in this section are not prior art to the claims in this application and any approaches described in this section are not admitted to be prior art by inclusion in this section.

Cloud computing enables network access to a shared pool of configurable resources that can be rapidly provisioned and released with minimum management effort. Cloud computing can be implemented based on one or more data centers implementing one or more physical computing machines known as servers the physical servers allocate compute and memory resources under the control of a management agent to form virtual machines . The virtual machines can provide computing services under the control of the management agent. Virtualization technologies enable a virtual machine to be moved dynamically from one physical server to a destination physical server where the destination physical server can be in the same data center or a different data center. The ability to move a virtual machine dynamically however introduces a number of challenges that necessitates the need for improved firewall protection for the movable virtual machine.

In one embodiment a method comprises detecting an initiation of a movement process of a virtual machine executed by a first physical host to a destination physical host initiating a transfer of a stateful process executed by a first network entity and providing enhanced network services for the virtual machine executed in the first physical host including causing execution parameters for the enhanced network services to be sent to a second network entity and completing the movement process of the virtual machine to the destination physical host in response to detecting the stateful process is executing in the second network entity and is ready to provide the enhanced network services for execution of the virtual machine in the destination physical host.

In another embodiment an apparatus comprises a first circuit and a processor circuit. The first circuit is configured for detecting an initiation of a movement process of a virtual machine executed by a first physical host to a destination physical host. The processor circuit is configured for initiating a transfer of a stateful process executed by a first network entity and providing enhanced network services for the virtual machine executed in the first physical host. The processor circuit is configured for causing execution parameters for the enhanced network services to be sent to a second network entity. The processor circuit further is configured for completing the movement process of the virtual machine to the destination physical host in response to detecting the stateful process is executing in the second network entity and is ready to provide the enhanced network services for execution of the virtual machine in the destination physical host.

Particular embodiments enable one or more virtual machines to be moved dynamically from one physical machine also referred to as a physical host in a data center to a second physical machine while maintaining firewall protection of the virtual machines before during and after the movement to the second physical machine. The particular embodiments enable the firewall protection to be dynamically transferred between physical machines providing firewall services also referred to as network entities even if the network entities are independent and distinct from the physical machines involved in the dynamic transfer of the virtual machines.

Conventional techniques for moving a virtual machine from a first physical host to a destination physical host encounter problems if the destination physical host is serviced by a different firewall device. For example assume the first physical host that executes the virtual machine before movement is associated with a first firewall device that protects the first physical host and the destination physical host receiving the virtual machine during the movement is protected by a second firewall device that is independent and distinct from the first firewall device the first physical host and the destination physical host assume further that the virtual machine established a plurality of network connections e.g. Transmission Control Protocol TCP connections during execution within the first physical host under the supervision of the first firewall device. The second firewall device associated with the destination physical host is not aware of the execution state of the virtual machine and is therefore not aware of any of the network connections established within the first physical host. Hence any network connections already established by the virtual machine during execution within the first physical host will be dropped by the second firewall device as soon as the virtual machine is transferred to the destination physical host.

Attempts to move the virtual machine by first disabling the firewall devices are inadequate because such attempts expose the virtual machine to attacks outside the data center. Attempts to execute the firewall process within the same hypervisor domain that controls and transfers the virtual machine also are inadequate because such virtualization of the firewall process within the same hypervisor domain as the virtual machine requires substantial computing resources hence virtualizing the firewall process within the same hypervisor domain as the virtual machine is not scalable especially if optimization of the firewall process relies on application specific integrated circuitry for executing at least part of the firewall process.

According to an example embodiment a first firewall device also referred to as a source network entity or a first network entity executes a firewall service for a virtual machine while the virtual machine is executed in the first physical host to provide virtualized services the first firewall device transfers to a destination firewall device execution state variables associated with the firewall service concurrently with the transfer of the virtual machine from the first physical host to a second physical host. In other words the first firewall device transfers the firewall state for the virtual machine to the destination firewall device. The destination firewall device also referred to as the destination network entity initiates the firewall service for the virtual machine moved into the second physical host prior to the activation of the virtual machine executed within the second physical host.

Hence the example embodiments enable virtualized movement of enhanced network services associated with a virtual machine without disabling the enhanced network services during movement of the virtual machine. Further the virtualized movement can be implemented in a scalable manner without any disruption of the virtualized services provided by the virtual machine.

Each of the virtual machines is executed in a physical host e.g. or under the control of a hypervisor . Each hypervisor enables multiple virtual machines to be executed concurrently on the corresponding physical host or . For example the example virtual machines VM VM and VM can be executed concurrently in the physical host under the control of a hypervisor executed by the physical host the example virtual machines VM VM VM and VM can be executed concurrently in the first physical host under the control of a hypervisor executed by the first physical host . Each virtual machine can include its own operating system instance and one or more application instances providing virtualized services. An example hypervisor is the commercially available VMware ESX Host that is commercially available from VMware Inc. Palo Alto Calif.

Each of the data centers also can include one or more access switches one or more distribution switches and one or more IP routers or equivalent switches connecting the corresponding data center to the IP network . An example of the access switches can include the commercially available Cisco Catalyst 6500 Series Switch from Cisco Systems San Jose Calif. An example distribution switch can include the commercially available Cisco Catalyst 6500 Series Switch from Cisco Systems. Hence the Cisco Catalyst 6500 Series Switch can implement the operations associated with the access switch and or the distribution switch .

As illustrated in B and C the first physical host the destination physical host the first network entity and the second network entity each are distinct and independent physical machines. The first network entity is configured for providing enhanced network services e.g. firewall protection for any processes executed in the first physical host and the second network entity is configured for providing enhanced network services for any processes executed in the physical host . Hence the illustrated firewall process F executed by the network entity provides firewall services for the virtual machine VM only during execution within the physical host

Hence the first network entity and the second network entity are outside the management domains of the hypervisors executed by the physical hosts and . Further the first network entity and the second network entity each can include application specific integrated circuitry ASICs for optimized execution of at least a part of the enhanced network services. Hence the hypervisors executed in the first and destination physical hosts and are distinct and independent from management interfaces executed in the first and second network entities and

The access switches can establish physical network connections for a virtual distributed switch under the control of a virtual switch manager VSM . The virtual distributed switch and the virtual switch manager can be implemented for example using the commercially available Cisco Nexus 1000V Series Virtual Switch Module from Cisco Systems.

The virtual distributed switch enables the virtual machine VM to be moved from the first physical host to the destination physical host under the control of a management entity executed by the apparatus and via the physical data links layer 2 established between the distribution switches and routers via the network network connections layer 3 also may be established between the distributed switches . In one embodiment the network can be implemented as a local area network providing a data center interconnect between the data centers within the same geographic location e.g. a building or an office campus in another embodiment the network can be implemented as a wide area network e.g. the Internet that connects the data centers separated by several hundred miles or thousands of miles.

As described below the user interface circuit and or the network interface circuit can be configured for receiving and detecting a request from the management user for initiation of the movement process of the virtual machine VM and or the stateful process F . The management entity can be configured for interpreting the request from the management user and in response sending notifications to the hypervisors to begin the movement process of the virtual machine VM to the destination physical host the management entity also can concurrently send notifications to the management interfaces executed in each of the network entities and to initiate transfer of the stateful process F to the second network entity . An example of the management entity can include the commercially available VMware VMotion from VMWare modified as described herein. For example the commercially available VMotion can be modified to include an executable resource e.g. a plug in that enables the VMotion to communicate and interact with the management interfaces executed in the network entities and

As illustrated in the apparatus also can include a memory circuit configured for storing compute storage attributes for example application state variables and data related to execution of the management entity .

In one embodiment the enhanced network services provided by the stateful process F provide firewall protection of the virtual machine VM . Each data center can include one or more network entities e.g. a firewall device configured for providing enhanced network services e.g. firewall services to the virtual machines . Although only the stateful process F providing the firewall protection for the virtual machine VM is illustrated it will be apparent that the network entities and each can provide independent and distinct stateful processes for the virtual machines executed in the corresponding associated physical hosts and . Although the enhanced network services are illustrated as firewall protection of the virtual machines other enhanced network services can include encryption services Virtual Private Network VPN services etc. Each data center can include a single firewall device for servicing the entire data center or a multiple firewall devices each configured for servicing a corresponding server cluster.

The management entity executed by the processor circuit can include logical management interfaces for controlling each of the hypervisors executed by the physical hosts and . The management entity also can include logical management interfaces e.g. Application Programming Interfaces APIs for communicating with the virtual switch manager enabling network traffic destined for the virtual machine VM to be redirected from the first physical host to the destination physical host following migration of the virtual machine VM enabling the movement of the virtual machine VM e.g. VMotion from the first physical host to the destination physical host via the virtual distributed switch .

The management entity also can include logical management interfaces e.g. APIs for communicating with the management interfaces executed in each of the network entities and . Hence the management entity can copy a stateful process F as illustrated in to the network entity as illustrated in based on causing the copying to the network entity of execution parameters used by the network entity to provide the enhanced network services to virtual machine VM in the first physical host . Example execution parameters can include firewall rules and firewall states for example identification of TCP connections opened by the virtual machine VM executed in the first physical host IP address es of the virtual machine VM executed in the first physical host IP addresses of clients in communication with the VM identification of the interface on which the firewall rules are to be applied the firewall state table that is relevant to the virtual machine VM being moved etc.

The management entity also can cause the first network entity to remove the execution parameters that were used to execute the stateful process F for the firewall services while the virtual machine VM was executed in the first physical host enabling the stateful process to be released for other virtual machines executed in the first physical host illustrated in . The stateful process executed in the first network entity need not necessarily be terminated and re instantiated rather a soft reset can be implemented based on deleting from the network entity the execution parameters associated with execution of the virtual machine VM within the physical host

As described previously illustrates the example system prior to movement of the virtual machine VM from the first physical host to the second physical host and prior to movement of the stateful process F from the first network entity to the second network entity . illustrates the transition of copying the virtual machine VM for example while in a paused state to the second physical host and copying the stateful process F for example while in a paused state to the second network entity . illustrates the completed movement of the virtual machine VM based on activation in the second physical host and the completed movement of the stateful process F based on activation in the second network entity and based on the termination in the first physical host of the virtual machine VM and the termination in the first network entity of the stateful process .

As described below with respect to the management entity executed by the processor circuit in the apparatus can detect initiation of a movement process of the virtual machine VM illustrated in e.g. in response to a user input via the user interface circuit and or the network interface circuit and in response initiate transfer of the stateful process e.g. firewall process F that provides the enhanced network services e.g. firewall protection for the virtual machine VM . The management entity also can ensure the stateful process F is executing in the second network entity and is ready to provide the enhanced network services for the virtual machine VM executed in the destination physical host illustrated in before activating the virtual machine VM to provide virtualized services from the destination physical host as illustrated in . The management entity also can send commands to the hypervisor in the first physical host to terminate the virtual machine VM and to the first network entity to remove the execution parameters from the stateful process illustrated in .

Any of the disclosed circuits of the apparatus including the processor circuit the memory circuit the interface circuit and their associated components can be implemented in multiple forms. Example implementations of the disclosed circuits include hardware logic that is implemented in a logic array such as a programmable logic array PLA a field programmable gate array FPGA or by mask programming of integrated circuits such as an application specific integrated circuit ASIC . Any of these circuits also can be implemented using a software based executable resource that is executed by a corresponding internal processor circuit such as a microprocessor circuit not shown and implemented using one or more integrated circuits where execution of executable code stored in an internal memory circuit e.g. within the memory circuit causes the integrated circuit s implementing the processor circuit to store application state variables in processor memory creating an executable application resource e.g. an application instance that performs the operations of the circuit as described herein. Hence use of the term circuit in this specification refers to both a hardware based circuit implemented using one or more integrated circuits and that includes logic for performing the described operations or a software based circuit that includes a processor circuit implemented using one or more integrated circuits the processor circuit including a reserved portion of processor memory for storage of application state data and application variables that are modified by execution of the executable code by a processor circuit. The memory circuit can be implemented for example using a non volatile memory such as a programmable read only memory PROM or an EPROM and or a volatile memory such as a DRAM etc.

Further any reference to outputting a message or outputting a packet or the like can be implemented based on creating the message packet in the form of a data structure and storing that data structure in a tangible memory medium in the disclosed apparatus e.g. in a transmit buffer . Any reference to outputting a message or outputting a packet or the like also can include electrically transmitting e.g. via wired electric current or wireless electric field as appropriate the message packet stored in the tangible memory medium to another network node via a communications medium e.g. a wired or wireless link as appropriate optical transmission also can be used as appropriate . Similarly any reference to receiving a message or receiving a packet or the like can be implemented based on the disclosed apparatus detecting the electrical or optical transmission of the message packet on the communications medium and storing the detected transmission as a data structure in a tangible memory medium in the disclosed apparatus e.g. in a receive buffer . Also note that the memory circuit can be implemented dynamically by the processor circuit for example based on memory address assignment and partitioning executed by the processor circuit .

As illustrated in with respect to the system of the interface circuit is configured for detecting in step an initiation of a movement process by a management user of the virtual machine VM executed by a first physical host to a destination physical host . The detecting of the initiation of the movement process can be based on the apparatus receiving a management user request via the user interface and or the network interface circuit for initiation of the movement process. Based on execution of the management entity the processor circuit detects the request from the management user requesting initiation of the movement process.

The management entity executed by the processor circuit initiates the transfer of the stateful process F in step based on first determining whether the second network entity is configured in a manner that is consistent with the first network entity . In particular the management entity determines whether the second network entity is able to execute the stateful process F in order to provide the enhanced network services e.g. firewall protection for the virtual machine VM that is to be executed in the destination physical host . For example the management entity can determine whether the second network entity permits virtualized movement of firewall services and or whether the second network entity includes compatible hardware and or software resources permitting the transfer and execution of the stateful process F in addition to any other processes already executed by the second network entity . Example hardware and or software resource can include verifying the second network entity has sufficient network interfaces has sufficient security levels etc. If the management entity determines the configuration of the second network entity inconsistent with the first network entity in a manner that does not enable transfer of the stateful process F a warning is sent to the management user in step and the transfer operation is terminated.

Assuming the management entity determines the second network entity has a configuration consistent with the first network entity that permits transfer of the stateful process F the management entity executed by the processor circuit can send in step a notification to the hypervisors executed in each of the first physical host and the destination physical host to begin the movement process of moving the virtual machine VM to the destination physical host . The appropriate notification s also can be sent to the virtual switch manager for management of network traffic associated with movement of the virtual machine VM .

The management entity also can initiate in step a transfer of the stateful process F from the first network entity to the second network entity . The management entity can send instructions for initiating the transfer to management interfaces executed in each of the first network entity and the second network entity . For example the management entity can send instructions to the network entities and specifying the properties of the virtual machine VM that is being moved for example IP address es MAC address es VLAN properties etc the management entity also can send properties of the source and destination physical hosts and and or properties of the source and destination network entities and

The management entity can cause execution parameters associated with the enhanced network services F to be sent to a second network entity based on determining in step whether control of enhanced network services are centralized. If in step the management entity determines that the control of enhanced network services are centralized the management entity can read in step the execution parameters from the network entity for the stateful process F protecting the virtual machine VM during execution in the first physical host . For example the management entity can send a request to the management interface executed in the network entity for the execution parameters associated with the stateful process F in response to the management entity receiving the execution parameters from the network entity the management entity can forward e.g. write in step the execution parameters to the management interface executed in the destination network entity

Alternately if in step centralized control is not implemented in the management entity the management entity can send in step a request to the first network entity to transfer the execution parameters to the second network entity

In one embodiment of the network entities and implemented as firewall devices the network entity also referred to as a source firewall device can forward firewall rules and firewall states for the firewall process F using a common layer 2 network between the firewall devices and . For example both the source firewall device and the destination firewall device can be configured with an interface on a virtual local area network VLAN that is extended between the two data centers via the network . The source firewall device can verify IP connectivity to the destination firewall device using TCP or Internet Control Message Protocol ICMP keepalive probe messages. The source firewall device can send a copy request for the stateful process F to the destination firewall devices in response to the source firewall device receiving a copy acknowledgment from the destination firewall device the source firewall device can send a copy data command to the destination firewall device where the copy data command includes the execution parameters for the stateful firewall process F the source firewall device and the destination firewall device can exchange copy and acknowledgment messages until copying of the execution parameters is complete. The processor circuit can be configured for causing the first network entity to send execution parameter updates in step to the second network entity prior to completion of the movement process of the virtual machine VM to the destination physical host

A combination of steps and also can be employed to transfer the execution parameters for the stateful process F from the first network entity to the second network entity

Various methods can be used to move the firewall rules from the source firewall device to the destination firewall device . In one embodiment the firewall rules can be defined by the management entity such that the firewall rules are maintained and supplied by the management entity as described with respect to step . The firewall policy for the stateful process F also can be parsed by the source firewall device such that all rules that apply to the virtual machine VM executed in the first physical host including host specific rules and broader rules for the supernet established for the data center Data Center 2 can be moved to the destination firewall device . The firewall policy for the stateful process F also can be derived from broader firewall rules based on the relevant supernet protected by the firewall device

In another embodiment the source firewall device and the destination firewall device can be configured with a layer 3 interface that is routable between the two data centers via the IP network enabling the firewall devices and to reside on different IP subnetworks communicating over a layer 3 network.

Each of the network entities and are configured for sending transfer notification messages to the management entity upon completion of the copying of the execution parameters associated with the enhanced network services F enabling the concurrent instantiation of the enhanced network services F in a paused state as illustrated in . Hence the apparatus receives a notification each from the first network entity and from the second network entity that the execution parameters have been successfully transferred to the second network entity . Hence the processor circuit executing the management entity is configured for detecting in step based on the notification messages from the network entities and that the stateful process F is executing in the second network entity and is ready to provide the enhanced network services for the virtual machine VM executed in the destination physical host

In response to detecting the notifications of step that the stateful process F is executing in the second network entity and is ready to provide the enhanced network services for execution of the virtual machine VM in the destination physical host the management entity executed by the processor circuit is configured for completing in step the movement process of the virtual machine VM to the destination physical host . The processor circuit is configured for detecting successful transfer of the virtual machine VM to the destination physical host for example based success messages from each of the source and destination hypervisors executed in the respective physical hosts and illustrated in . As described previously each of the virtual machine VM and the firewall process F can be in a paused state during the transfer illustrated in .

The management entity is configured for responding to the detected successful transfer of the virtual machine VM by sending in step a first notification to the second network entity to activate the enhanced network services F for the virtual machine VM in the destination physical host and a second notification to the first network entity to remove the execution parameters for the virtual machine VM from the stateful process F . Once the enhanced network services F in the network entity are activated the management entity can send instructions to the hypervisor in the physical host to activate the virtual machine VM and to the hypervisor in the physical host to terminate the virtual machine VM illustrated in .

According to example embodiments enhanced network services such as firewall services for a virtual machine can be dynamically transferred ensuring the continued protection of the virtual machine during movement in a scalable manner.

While the example embodiments in the present disclosure have been described in connection with what is presently considered to be the best mode for carrying out the subject matter specified in the appended claims it is to be understood that the example embodiments are only illustrative and are not to restrict the subject matter specified in the appended claims.


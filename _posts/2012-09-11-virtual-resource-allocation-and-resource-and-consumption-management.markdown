---

title: Virtual resource allocation and resource and consumption management
abstract: Clients access compute resources in a data center organized in logical clusters. A cluster level quota governs access to the compute resources, regardless of the location of the resources which can be part of multiple computers or part of multiple data centers. The cluster level quota can manage allocation and usage of storage, memory, and CPU resources in multi-tenant data center environments. A user requests a computing resource from a logical compute cluster in a data center of host machines hosting virtual machines. According to permissions associated with the user for the logical compute cluster and a cluster quota, the system grants access to the computing resource to the user in response to the request when the cluster quota permits an expected use of the computing resource according to the request.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09384056&OS=09384056&RS=09384056
owner: Red Hat Israel, Ltd.
number: 09384056
owner_city: Raanana
owner_country: IL
publication_date: 20120911
---
Embodiments of the present invention relate to resource management and more specifically to applying resource quotas to a cluster layer.

Data centers often provide virtualization services for clients. For example a data center with multiple machines can allocate storage processors memory network bandwidth and other resources to virtual machines operating within the data center. Users of the virtual machines or the virtual machines themselves consume resources of the data center. Resource usage is typically limited by available resources. The data center is unable to limit the resources that can be used by a user. While this is not a serious issue in a single user environment in which a user can consume any available resources without limitation this arrangement can be especially problematic in multi user environments. In a multi user environment multiple users attempt to use the same data center resources. Thus two users may attempt to allocate or use the same set of resources. Similarly the data center is unable to ensure that particular resources will be available for a particular user because other users may suddenly start using those resources.

Described herein is a system a method and apparatus for implementing and enforcing a quota that provides a virtual logic applicative mechanism for limiting and enforcing user resource usage in a data center at the cluster layer and not restricted to the physical layer. A cluster layer quota applies to the cluster above the physical layer and above any storage domains. Thus the cluster layer quota can restrict or constrain resource usage across an entire cluster. A cluster can be a group of computing devices which are connected via one or more networks and which can cooperate to perform computing tasks. A user can access all or part of a cluster as a single entity without accessing individual computing devices that make up the cluster. Clusters can be administered or controlled via a master computing node or can include computing devices which are peers without such a master computing node. The cluster layer quota applies to resource usage across multiple devices in a physical or logical cluster of computing devices for a particular compute job user user group or other entity. For example a physical layer quota can restrict resource usage on a single physical machine such as restricting a virtual machine to 2 gigabytes of memory on the physical machine. A cluster layer quota can restrict or constrain resource usage on multiple physical machines in the cluster or data center such as restricting a user of the data center to a total of 64 gigabytes of memory in aggregated use across all physical machines. The resource usage in the cluster layer quota can be applied to multiple different projects such as multiple virtual machines running under the control or direction of a single entity such as a user or multiple entities such as a group of users participating in a shared computing project. Other entities include automated processes which may invoke sub processes to be run on the cluster subject to a cluster layer quota. For example with a cluster layer quota of 64 gigabytes of memory the user can operate a first virtual machine using 32 gigabytes of memory on a first machine in the data center a second virtual machine using 16 gigabytes of memory on a second machine in the data center and third and fourth virtual machines each using 8 gigabytes of memory on a same third machine in the data center. Cluster layer quotas can be applied in addition to physical layer quotas to enforce overall usage of the data center in addition to restricting usage of resources on specific machines.

The quota can be configured by defining a set of rules. The quantity and type of rules for a particular quota can vary for different quotas. For example rules defining the scope of a storage quota can be defined in terms of gigabytes while rules defining the scope of a cluster quota can define an amount of virtual memory and a number of virtual CPUs or CPU cores. Quota limitations and rules can be defined globally for the entire data center or locally for each storage domain of a specific cluster or specifically for one scope and globally for another. A storage domain is a set of storage devices available to a specific cluster. The storage domain can include local disks of various computing devices as well as a dedicated storage device such as a network attached storage NAS device. A cluster can use one or more storage domains but may use a portion of a storage domain at any given time.

The resource management server can be configured to handle quotas differently. For example the resource management server can be configured to enforce quota restrictions to use a permissive mode for generating usage audit logs to avoid using quotas at all or to disable quotas or to use a permissive mode. In an embodiment a quote can be verified in a disable mode an enforce mode or a permissive mode. In disable mode no conditions are checked. In enforce mode the user is blocked when operations exceeds the designated limitations. In audit or permissive mode audit logs are provided along with warnings when limitations are to be exceeded but the user is not blocked from performed the desired operation.

In an embodiment quotas can include a threshold limit or a grace limit which can be measured in a percentage threshold limit or an absolute threshold. In one embodiment of a percentage threshold the data center can allow a quota grace limit for a user so that resources consumed by the user can exceed the quota by 5 . In an embodiment of an absolute threshold the data center can allow a quota grace limit for a user so that storage resources consumed by the user can exceed the quota by 2 gigabytes. The data center can display or otherwise provide to the user a message when the grace limit is being applied or when the grace limit is exceeded.

The data center can include a quota manager which may be incorporated as part of the cluster quota enforcement subsystem that checks and enforces quota compliance such as when specific events occur. For example the quota manager can validate a storage quota when adding a new disk to a virtual machine or launching a virtual machine that uses a currently unused disk. Similarly the quota manager can validate a cluster quota when launching a new virtual machine or cloning a running virtual machine. These quota compliance events can be based on specific user actions or based on specific data center actions. In one example a user request for a new virtual machine can include an instruction to invoke the quota manager to review and validate the user request prior to its execution. In another example the quota manager is linked to data center command to load a new virtual machine so that attempts to execute the command to load a new virtual machine are intercepted and the quota manager can validate the quota prior to executing the command. In an alternate embodiment the quota manager monitors the data center environment at some interval or continuously to check and enforce quota compliance.

The validation of storage quotas may be synchronized with parallel operations requesting to consume storage space under the quota. For example the data center can maintain a cache in memory that maps commands to quota resources to be used when the command is executed and deletes commands from the map after the command is executed and the quota resources are allocated or in use. Validation for quota space can also incorporate data describing existing images of virtual machines or running virtual machines as well as the map of ongoing commands which the quota is processing for approval or which may still request the use of additional resources.

Quotas can provide a logic mechanism for a data center administrator to manage resource allocation for users and groups in the data center. A quota management console can allow the administrator to manage share and monitor the resources in the data center from the engine core point of view as well as add remove enable disable or modify quotas monitor grace limits add or remove users from quotas and so forth.

A quota can be a separate searchable object in the data center. In one embodiment a quota can include a name description data center to which the quota applies a list of any number of rules specifying a resource and resource limitation parameters a list of users or groups that have permission to use the quota and allowed actions for the list of users or groups.

The example quota below is provided as one embodiment of a quota for a research and development team.

The limitation on a resource can be specified either on a specific resource or globally. The example above illustrates a limitation on a specific resource such as restricting the Storage Domain1 to 20 GB or restricting Cluster1 to 6 virtual CPUs and 9 GB of RAM. In an example of a global resource limitation the example research and development quota can indicate for example that the storage limitation is a total of 80 GB regardless of which storage domain s the storage space is used. However the global storage limitation can provide further storage domain specific details such as indicating a global storage limitation totaling 40 GB with no more than 20 GB on any single storage domain. The global resource can define limitations on the data center for a specific type of resource such as storage or CPU time. Some additional examples of global limitations on the Cluster and the Storage are provided below 

A quota limitation can be also set to unlimited both globally or on a specific resource. Portions of a quota which are unlimited can be determined based on an explicit entry in the quota or based on an absence of any specific restriction on the resource. A set of example unlimited quota limitations are provided below where the global quota is unlimited but the quota on storage domain2 is limited within the global quota 

The quota object can be in the data center scope. Further a data center can be related to at least one quota object. Each data center entity can be configured with one of the following operation modes disable soft limit or hard limit. In the disable operation mode the data center either does not apply to implement quota restrictions ignores quota restrictions or is otherwise not subject to quota restrictions. In the soft limit operation mode the data center issues warning messages when quota restrictions are exceeded or about to be exceeded. In the hard limit operation mode the data center can enforce the quota restrictions completely and prevent requests for resource allocation or other resource usage which would exceed the quota restrictions. In one embodiment the data center operates in different modes for different users. For example the data center can apply the soft limit operation mode to a first user or user group while simultaneously applying the hard limit operation mode to a second user or user group. The user who created the quota object may or may not have permissions to consume resources under the quota object.

In one embodiment a quota object can be deleted removed or otherwise disabled only when no entities such as a virtual machine or a template are referencing the quota object. The data center can either wait to delete the quota object until the entities are done using resources under the quota object or the data center can force a release of the entities use of the resources prior to deleting the quota object. Quota objects can be edited. When a quota object is edited the data center can apply any changes to all entities that are assigned to the quota but only for future allocations of resources. However a change in the parameters of a quota object can result in an entity s use exceeding the new resource limitations. For example the quota object may be edited to reduce the disk limitation of some storage domain reduce CPU RAM limitations or remove a user from the list of users permitted to use the quota. When a quota object is edited to reduce the available resources or the number of permitted users the existing use of the data center continues in excess of the edited quota object but users will not be able to exceed the quota object limitations again after the resources are released. In one variation an administrator or other user can indicate which currently used resources under the quota object should be forcibly released to conform to the reduced quota limits. Similarly if a user is removed from the list of permitted users for a quota object the data center will not take an immediate interruptive action against the removed user. However that user will be unable to use this quota again unless permission is re granted.

The data center can provide a wizard or other graphical user interface for an administrator to manage quota objects. For example the administrator can create or edit a quota via the wizard. The wizard can allow administrators to configure cluster quota parameters storage quota parameters and assign users groups of users or other entities which are authorized to consume the resources under the quota. Quotas can be cloned so that an administrator can quickly duplicate the settings of a quota for one user and apply those settings to a separate quota for a different user. In one implementation the cloning operation copies all the quota properties except for the name and the description. The administrator can specify exactly which properties are copied from a source quota to a cloned quota.

In one embodiment the data center assigns users associated with the quota power user permission on the consumable resources. For example when users add or edit a virtual machine the data center can grant users the applicable permissions for that virtual machine. The data center can through the wizard interface automatically add or create these permissions. However in one embodiment the data center does not remove permissions when removing resources from the quota but can present an alert message. The alert message can state Attention quota QuotaName resources have been changed. If needed update relevant permissions accordingly. 

The data center can provide an aggregated view of defined quotas versus actual storage space used free. illustrate various example embodiments of user interfaces. The example user interfaces can be part of an administrator portal or user portal. An administrator portal or interface can allow an administrator to view edit or create quotas and to view quotas by resource such as by user cluster or storage domain. A user portal can allow a user to view quotas defined or used by him or her self and consume quotas based on resource usage such as CPU usage and storage usage. In one embodiment a single portal or interface can provide administrator functionality for some quotas and user functionality for other quotas for a same user.

In an embodiment for a new or upgraded data center the default operation mode can be disabled which means the data center is not subject to any quota restrictions ignores quota restrictions or does not apply quota restrictions. Alternatively the data center can implicitly create an unlimited quota object and attach all objects clusters users or other entities to the unlimited quota object. The data center can allow all users to access and consume resources under the unlimited quota object. Then when an administrator or other user chooses to enable the quota mechanism he or she can remove permissions to the unlimited quota or can disable or remove the unlimited quota. In an embodiment when a data center is updated the system can create an automatic default quota for the data center with permissions for everyone and unlimited space for storage and cluster use. In an embodiment when the data center operates in disabled mode the default quota may be the one that all the resources are consumed from and when the data center becomes active this default quota may behave as a regular quota.

In one embodiment users can edit the default quota only when the data center quota mode is not disabled. When a user edits the default quota the quota will lose its default flag and the system can prompt the user to change the quota name prefix for example. When the user changes the data center quota mode back to disabled the data center can check whether the default quota was changed or not. In this example if the default quota was not changed then the default quota stays the same and permission for Everyone will be added to it. If no default quota was found which means that the default quota was changed when the data center was not disabled then the data center can create a new default quota with a default name or some other name.

The data center can enforce quotas at various times. In one embodiment the data center enforces quotas as runtime limitations enforced during execution of a virtual machine. Specific quotas or specific portions of quotas can be enforced at specific event types related to or based on the type of the specific quota. For example the data center can enforce a quota storage limitation upon any requirement or request to allocate storage such as a request to store a file or open a virtual disk image. Certain types of virtual machine storage such as Quick EMUlator QEMU Copy on Write QCOW delay allocation of storage until storage is actually needed. In other words QCOW virtual disks are not pre allocated like templates or a stateless virtual machine. When the data center handles QCOW write requests the data center can ensure that the quota consumes the total maximum size of the disk since that is the maximum potential size that can be used by a QCOW write request. In another variation the system can attempt to determine an expected write size or an average write size and ensure that the quota can handle that expected or average size or the expected or average size plus an additional amount of storage. Then if the actual amount of storage exceeds the expected or average size and the additional amount of storage the data center can provide a message to the user either notifying the user that the storage transaction failed or prompting the user to provide the additional storage. Then the user can either free up other storage resources under the storage quota or expand the storage quota. Similar principles can be applied to network usage quotas by allocating a set amount of transmission throughput for a network request in advance of completing the network request or by allocating a recurring or periodic expected amount of network transmission throughput for a particular network activity.

The data center can configure alerts for quotas when a quota is about to be full or exceeded. Both users and administrators can configure alerts as well as thresholds that can trigger the alerts. The data center can implement default alerts and thresholds for the alerts. In one embodiment the default threshold for administrators is 60 of the quota and for regular users is 75 of the quota. So if the administrator is using more than 60 of the storage quota then the system can send an alert to the administrator or to some other user. Alerts can be graphical auditory or provide some other indication to the user. Alerts can include pop up messages in a GUI an entry in a log file an email or text message and so forth. The system can send alerts periodically as long as the threshold is exceeded once when the threshold is exceeded or at specific events that cause increase usage of resources under the quota beyond the threshold.

The data center can maintain a history of quota utilization which can include log entries. Then a user can browse and view historic quota utilization to determine if a particular quota is too high or too low or to identify problem areas or peak usage times.

When the quota reaches the threshold limit the data center can issue an audit log notification to the administrator or the user which can state Usage on resource Resource in quota Quota Name has reached the configured threshold Threshold User Percentage. Please contact your system administrator. An example administrator audit log can state Usage on resource Resource in quota Quota Name has reached the configured threshold Threshold Admin Percentage. With this and other notifications the data center can be configured to delay or postpone notifications so that a user does not get flooded with similar notifications. Alternately the data center can provide a digest of all notifications at a specific time interval such as every 30 minutes or every 24 hours.

The data center can assign a configurable grace percentage to a quota user or group of users. A grace percentage can allow a user to have a chance to consume resources even if the quota has exceeded the limit. When use of a quota reaches its resources limit the user will still be able to consume resources depending on the grace percentage. The data center can implement a default grace period such as 20 of the quota resource limitations. When user starts to use resources under the grace percentage the data center can trigger a notification event to the administrator and to any users associated with exceeding the grace limit. The data center can issue an audit log warning message to the user and the administrator such as Usage on resource Resource in Quota Quota Name has reached its limit due to an action made by user UserName. The administrator can set an email event when Quota resources exceed their limit.

The data center can implement cluster level quotas independently of outside features and can be implemented and managed within the scope of the data center engine core. When handling plug unplug disks or attach detach disks the entity can still consume resources from its configured original Quota on which the entity was created.

Upon determining that the cluster quota permits an expected use of the computing resource according to the request the data center grants access to the computing resource to the user in response to the request . The data center can further record the request and associated use of the computing resource in a log. The data center can optionally monitor usage of the computing resource. Upon determining that usage of the computing resource is within a threshold of a maximum usage indicated by the cluster quota the data center can send an alert that usage of the computing resources is within the threshold. The alert can be sent to the user responsible for using the computing resource or to an administrator or other user managing usage of resources under the cluster quota. Similarly the data center can monitor usage of the computing resource and determine that the usage of the computing resource exceeds a maximum usage indicated by the cluster quota. The data center can then send an alert that usage of the computing resource exceeds the maximum usage. The data center can further deny additional requests for the computing resource until the usage is below the maximum usage or can determine that the usage of the computing resource is within a grace limit and notify the user that the usage of the computing resource is within the grace limit.

In an alternative embodiment the data center receives a request from a user for compute resources in a logical cluster within a data center wherein the user is associated with the logical cluster and wherein the logical cluster is associated with a cluster quota and calculates an expected resource quantity to satisfy the request. Then the data center determines that the logical cluster has sufficient available compute resources to satisfy the request based on the expected resource quantity and determines that the cluster quota allows usage of the expected resource quantity in the logical cluster. If these conditions are met the data center grants access to the computing resource in the logical cluster to the user in response to the request.

The example computer system includes a processing device a main memory e.g. read only memory ROM flash memory dynamic random access memory DRAM such as synchronous DRAM SDRAM or Rambus DRAM RDRAM etc. a static memory e.g. flash memory static random access memory SRAM etc. and a secondary memory e.g. a data storage device which communicate with each other via a bus .

Processing device represents one or more general purpose processing devices such as a microprocessor central processing unit or the like. More particularly the processing device may be a complex instruction set computing CISC microprocessor reduced instruction set computing RISC microprocessor very long instruction word VLIW microprocessor processor implementing other instruction sets or processors implementing a combination of instruction sets. Processing device may also be one or more special purpose processing devices such as an application specific integrated circuit ASIC a field programmable gate array FPGA a digital signal processor DSP network processor or the like. Processing device is configured to execute processing logic e.g. instructions for an quota enforcement subsystem for performing the operations and steps discussed herein.

The computer system may further include a network interface device . The computer system also may include a video display unit e.g. a liquid crystal display LCD or a cathode ray tube CRT an alphanumeric input device e.g. a keyboard a cursor control device e.g. a mouse other user input device such as a touch screen or a microphone and a signal generation device e.g. a speaker .

The secondary memory may include a machine readable storage medium or more specifically a computer readable storage medium on which is stored one or more sets of instructions for the quota enforcement subsystem embodying any one or more of the methodologies or functions described herein. The instructions may also reside completely or at least partially within the main memory or within the processing device during execution thereof by the computer system the main memory and the processing device also constituting machine readable storage media.

The computer readable storage medium may also be used to store a problem resolution manager which may correspond to the quota enforcement subsystem of or a software library containing methods that call a quota enforcement subsystem . While the computer readable storage medium is shown in an example embodiment to be a single medium the term computer readable storage medium should be taken to include a single medium or multiple media e.g. a centralized or distributed database or associated caches and servers that store the one or more sets of instructions. The term computer readable storage medium shall also be taken to include any medium that is capable of storing or encoding a set of instructions for execution by the machine and that cause the machine to perform any one or more of the methodologies of the present invention. The term computer readable storage medium shall accordingly be taken to include but not be limited to solid state memories and optical and magnetic media.

It is to be understood that the above description is intended to be illustrative and not restrictive. Many other embodiments will be apparent to those of skill in the art upon reading and understanding the above description. Although the present invention has been described with reference to specific example embodiments it will be recognized that the invention is not limited to the embodiments described but can be practiced with modification and alteration within the spirit and scope of the appended claims. Accordingly the specification and drawings are to be regarded in an illustrative sense rather than a restrictive sense. The scope of the invention should therefore be determined with reference to the appended claims along with the full scope of equivalents to which such claims are entitled.


---

title: Communication across domains
abstract: Communication across domains is described. In at least one implementation, a determination is made that an amount of data to be communicated via an Iframe exceeds a threshold amount. The data is divided into a plurality of portions that do not exceed the threshold amount. A plurality of messages is formed to communicate the divided data across domains.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08489878&OS=08489878&RS=08489878
owner: Microsoft Corporation
number: 08489878
owner_city: Redmond
owner_country: US
publication_date: 20120313
---
This application is a continuation of and claims priority to U.S. patent application Ser. No. 11 805 088 filed May 22 2007 which is a continuation in part of and claims priority to U.S. patent application Ser. No. 11 426 174 filed Jun. 23 2006 the entire disclosures of which are incorporated by reference.

Through the use of web browsers also known simply as browsers users may obtain a wide variety of content from the Internet such as online banking email and so on. However the users may also be exposed to malicious parties via the Internet when browsing between network sites. For example a malicious party may engage in a phishing scheme to obtain personal information from the users which may then be used to steal the users identities such as to purchase goods and services using credit information obtains from the users. In another example the malicious party may attempt a hack to disable the users computers obtain personal information and so on.

One technique that was developed to protect against these malicious parties employs security mechanisms around Cross Site Scripting XSS which is used to prevent a single webpage from having multiple domains freely share data. For example web pages are typically associated with domains. If a webpage from a domain attempts to communicate or execute a script on a webpage from another domain typical browsers will disallow the communication or script execution. However this may also serve to limit functionality available to the users that may also be used for legitimate purposes such as to share data between trusted domains.

Communication across domains is described. In at least one implementation a determination is made that an amount of data to be communicated via an Iframe exceeds a threshold amount. The data is divided into a plurality of portions that do not exceed the threshold amount. A plurality of messages is formed to communicate the divided data across domains.

This Summary is provided to introduce a selection of concepts in a simplified form that are further described below in the Detailed Description. This Summary is not intended to identify key features or essential features of the claimed subject matter nor is it intended to be used as an aid in determining the scope of the claimed subject matter.

Various embodiments utilize nested Iframes within a web page to allow cross domain communication. That is various embodiments can create an embedded Iframe that shares the domain of an Iframe or web page with which communication is desired. Because the embedded Iframe shares the domain of the Iframe or web page with which communication is desired restrictions on cross site scripting do not inhibit communication or scripting between the domain matched Iframe s and or web page. This embedded Iframe can then provide a mechanism by which web pages or Iframes from other domains can communicate with the Iframe or web page with which the embedded Iframe shares a domain.

The inventive approach can be utilized in the context of sending insecure and secure messages. Further in at least some embodiments reliability can be enhanced by providing a reliability mechanism that can be used to track and confirm messages that are sent back and forth between the domain matched Iframe and web page.

Iframes and the manner in which Iframes work will be appreciated by the skilled artisan and as such are not described in great detail here. However for some basic context on Iframes consider the following.

An Iframe is a construct which embeds a document such as a web page into an HTML document. Traditionally Iframes have been used so that embedded data can be displayed inside a sub window of the browser s window. This does not mean full inclusion the two documents are independent and both them are treated as complete documents instead of treating one as part of the other.

In the discussion below the following primary sections are provided. First a section entitled Exemplary Environment is provided and describes but one example of an environment in which the inventive embodiments can be employed. Following this a section entitled Establishing a Cross Domain Message Delivery System is provided and describes how a cross domain message delivery system can be created in accordance with one embodiment. Next a section entitled Using the Cross Domain Message Delivery System is provided and describes how one can use the cross domain message delivery system in accordance with one embodiment. Following this a section entitled Reliable Messaging is provided and describes one embodiment in which a degree of reliability can be added to the cross domain communication of messages. Further a section entitled Using Cross Domain Communication to Facilitate Social Networking is provided and describes but one example of how cross domain communication can be utilized. Yet further a section entitled Cross Domain Communication of Data over a Threshold Amount describes but one example of how cross domain communication can be utilized using a plurality of messages to communicate data greater than an amount permitted in a single message. Yet still further a section entitled Asynchronous Cross Domain Communication describes but one example of an asynchronous communication that may be performed utilizing a buffer although implementations are also contemplated in which asynchronous communication is performed without a buffer. Finally a section entitled Cross Domain Communication Security Techniques describes examples of security techniques that may be employed to provide cross domain communication such as a permissions based security mechanism which asks for confirmation of data to be sent to a third party site.

Web browser is configured to communicate with one or more servers via a network such as the Internet . In practice browser can receive web content from server and render such content for a user in the form of a web page an example of which is shown at . In the examples below browser can be used to render Iframes within a web page to create a cross domain message delivery system that can permit cross domain communication as will become apparent.

It is to be appreciated and understood that while computing device is illustrated as a desk top computing device other computing devices such as laptop devices notebook devices handheld devices and the like can be utilized without departing from the spirit and scope of the claimed embodiments.

Web page is said to be a containing page because it contains the two created Iframes. In this example web page has been created in a first domain domain A. Notice here that Iframe has been created in domain A and Iframe has been created in domain B. Each of Iframes and includes or contains in this example a listener Iframe that shares its Iframe s domain. Hence Iframe contains listener Iframe and Iframe contains listener Iframe . Iframes and can be considered as containing frames because they contain other Iframes. The listener Iframes can be considered as embedded or nested Iframes that serve as target windows for cross domain communication that takes place as will become apparent below.

In accordance with one embodiment the cross domain message delivery system can be created as follows.

When the containing page here page loads it creates Iframe in its own domain and passes into the Iframe a name that is to be used for a corresponding listener Iframe. Although any suitable name can be used in this example the name comprises a private hash which in the illustrated example is represented as abc . Iframe then creates the listener or nested Iframe in its domain using the private hash as its name. Nested Iframe is associated with a URL that is used for cross domain communication and is the message receiver or target window for messages intended for containing page .

In addition containing page can also create Iframe in a different domain domain B and pass in a name that is to be used for a corresponding listener Iframe. Although any suitable name can be used in this example the name comprises a private hash which in the illustrated example is represented as def . Iframe then creates the listener or nested Iframe in its domain using the private hash as its name. Nested Iframe is associated with a URL that is used for cross domain communication and serves as the message receiver or target window for messages intended for the containing Iframe .

In this example if communication is to take place between Iframes and each is provided with the name of the listener Iframe for the other. So for example Iframe is provided with the name def and Iframe is provided with the name abc . This can typically take place when the Iframe is initially created in the containing page .

Step loads a containing web page and step creates an Iframe that is contained within the web page. Step can be performed multiple different times to create multiple different Iframes in the same and or different domains from that of the containing web page. Step passes a name to the Iframe. This step can be performed multiple different times as well and can be performed as part of the process of creating the Iframe. The name is to be used in connection with a nested listener Iframe that is to be created. Step creates a nested Iframe using the name that was passed to the Iframe. This step can be performed multiple different times and can be performed by a corresponding Iframe that was created.

At this point a cross domain message system such as that illustrated in has been created and can be used to message across different domains.

In accordance with one embodiment when a web page from a different domain wishes to communicate with a particular Iframe it manipulates a URL associated with the Iframe s listener Iframe and includes in the URL the message that is desired to be communicated to the Iframe. In this particular example cross domain communication can take place in connection with a server. This can permit a degree of security that is provided by the server. That is the server can process the cross domain messages in many different ways such as by validating the messages verifying the sender and the like.

For example in the example of assume that web page wishes to communicate with Iframe . To do so web page might initiate a server call to open a window or load a page in the listener Iframe for Iframe as follows 

Assuming that any security issues pertaining to the message are resolved favorably the server then causes the message to load in the nested Iframe which is in Iframe s domain. Nested Iframe can then notify its parent or containing Iframe that it has a message. Iframe can then process the message accordingly as by executing scripts using the message.

To respond Iframe would simply issue a call to open a window or load a page in the listener Iframe for Iframe . This call routed through the server would then cause a window to be opened or a page which contains the message to be loaded in listener Iframe

This process is diagrammatically shown in . Here web page initiates a call to open a window in the listener Iframe for Iframe . The call which includes the message that is to be communicated across different domains is routed through the server and the server then causes a corresponding window or page to be loaded in the listener Iframe for Iframe . This page includes the message from web page . Hence using this approach can allow messages and other information to be communicated across different domains.

Step creates a message that is intended to be communicated to a different domain. Any suitable type of message can be created. For example one message might be a refresh message that causes another document to refresh e.g. a stock list component can be notified to refresh stock quotes. Other messages can present ambient properties pertaining to the mode of a page such as author versus view mode or share stylistic information e.g. a stock quote component can switch to allow new stocks to be added or a particular theme can be shared with the component. Further some messages can request metadata e.g. a list of contacts books and the like can be requested and returned to the other page .

Step includes the message in a URL associated with a listener Iframe in the different domain. One example of how this can be done is provided above. Step initiates a call to a server that includes the URL. One example of how this can be done is provided above.

Step receives the call from the client at the server and step processes the message. Any suitable processing can take place. In the example above the processing that takes place pertains to security. Other types of processing can take place. Step returns to the client to cause the message to be processed by the listener Iframe.

Step processes the message with the listener Iframe and step notifies the containing Iframe that a message has been received. This step is performed by the listener Iframe.

In the embodiment described just above a server is utilized to facilitate cross domain message delivery. Incorporating a server into the process can enable the message processing to be augmented in some way such as by providing server enhanced security processes. It is possible however for cross domain message delivery to take place in a purely client side manner without round tripping to the server.

In this embodiment cross domain messages are sent by manipulating the URL of the Iframe that is contained with a web page. As an example consider the following. Each individual Iframe in a web page is associated with an URL. An URL typically has the following form 

The authority typically consists of the name or IP address of a server optionally followed by a colon and a TCP port number. It may also contain a username and password for authenticating to the server. The path is a specification of a location in some hierarchical structure using a slash as delimiter between components. The query typically expresses parameters of a dynamic query to some database program or script residing on the server. The fragment occurs after the hash and identifies a portion of a resource often a location in a document. Fragments or hashes are interpreted on the client side and are not typically used by the server.

In accordance with this embodiment when a containing page from a different domain wishes to communicate or send a message to an Iframe in another domain it appends the message to the appropriate Iframe s URL after the hash. Thus a message to an Iframe from another domain would take the following form 

When the Iframe detects the URL change it can parse the URL to access the message and can then process the message accordingly. If the Iframe wishes to communicate back to the containing page or another listener it uses a similar approach that is it manipulates the URL of the intended recipient to append the message after the hash in the recipient s URL. If the intended recipient is a listener Iframe for the containing page then the listener Iframe can receive the message and because it shares the domain of the containing page it can call functions in the containing page such as a notification function to notify the containing page that it has received a new message.

In this embodiment all of the message sending and receiving can take place without round tripping to the server. Thus server resources can be conserved.

In at least some embodiments message reliability can be enhanced by adding a unique message counter associated with each message that is sent from a particular domain. For example in some instances a particular Iframe may be the subject of a number of incoming messages. Yet if these messages arrive at the same time there is a chance that at least some of the messages will be missed. In this case each message from a particular domain is associated with a unique incremental ID that is incremented for each new message from that domain. When the Iframe receives a particular message from a particular domain if the message counter is off by one or more increments then the Iframe knows to request the missing messages from the sender. The message counter can be implemented as a field in the URL associated with the targeted recipient of the message.

Alternately or additionally reliable messaging can be enhanced by having individual Iframes communicate back acknowledgements to the message originator that a particular message has been received. The message originator can also if so desired query the recipient to ascertain whether the recipient received the message.

Using the above described approach a containing web page can also act as an intermediary between Iframes from different domains or allow the frames to communicate directly by giving each the name of the target window in the other. One of the things that this can enable is remote procedure calls or RPC. That is a message schema can be utilized that allows messages to be defined for invoking methods or operations in other domains. In this way a distributed RPC like mechanism is provided for executing actions in other domains.

There are instances when it would be desirable to enable a third party web site to utilize aspects of a user s relationships with others to provide the user a rich experience. For example a user may have a large buddy list as part of their instant messaging application. Some third party web site might have applications that could provide the user with a rich and robust experience if it only had access to the buddy list. For example a third party web site might be able to show you all of your buddies wish lists. Yet for purposes of privacy it is not desirable to provide the third party web site with access to the user s buddy list.

In the embodiment described below nested Iframes are utilized to provide a rich and robust experience in which relationship information can be shared yet protected.

As an example consider . There a web page or containing page created in domain A includes an Iframe created in domain B a buddy list that has been rendered in domain B and an Iframe in domain A that is contained within Iframe . Because of restrictions on cross site scripting neither web page nor Iframe can access the buddy list that resides in domain B. Yet there are circumstances when it might be desirable to allow web page to use relationship information associated with buddy list while at the same time allow cross site scripting restrictions to disallow access to the buddy list.

That is in this instance the ability is provided to send information associated with Iframe to web page . In accordance with one embodiment when web page loads it creates Iframe and provides it with a postback URL that can be used to communicate with web page . When Iframe creates nested Iframe in the same domain as web page it provides the nested Iframe with information on the postback URL. Since Iframe and web page are in the same domain there are no cross site scripting restrictions that would prevent them from communicating. The web page and Iframe can now communicate using for example JavaScript.

Consider now in conjunction with the following example. Assume that web page is associated with a large on line retailer that sells books music CDs and the like. Assume also that a user has browsed to the page and responsively Iframe has loaded their buddy list. Assume also that web page asks the user if they would like to view wish lists for any of their buddies. Assume now that the user clicks on one of their buddies. In this embodiment each buddy is mappable to a unique ID or Guid. Because of cross site scripting restrictions this mapping is available within domain B but not domain A. The Guid for the user s particular friend is retrieved and rendered as a web page inside Iframe using for example techniques described above. Now using the Guid that was just rendered Iframe uses the web page s post back URL or some other form of communication to provide the Guid to web page . Having the Guid web page has access to a mapping of Guids to wish lists. Hence the web page can now render the particular buddy s wish list for the user without having access to the buddy s identity or any other of the buddy s information.

In this way third party web sites can access and leverage relationship information associated with a particular user while at the same time such relationship information is protected.

In accordance with one embodiment cross domain communication may be utilized to communicate data that exceeds a threshold amount that is permitted to be communicated using a single message. For example in some instances a threshold may be set at 2 083 bytes which corresponds to an amount of data that may be permitted for communication in a single tag. To permit communication of amount of data that are greater than this threshold amount a chunking technique may be implemented to divide this data from communication across domains using a plurality of messages.

Step receives data that is intended to be communicated to a different domain. The data may be configured for a variety of purposes such as refresh messages present ambient properties request metadata and so on as previously described.

Step determines that an amount of data to be communicated via an Iframe exceeds a threshold amount. A sender e.g. an Iframe or a webpage for instance may determine that the amount of data to be communicated to a recipient e.g. another Iframe or webpage exceeds 2083 bytes which is an amount of data in an implementation that is permitted to be communicated via an Iframe in a single message.

Step divides the data into a plurality of portions that do not exceed the threshold amount. For example the sender may divide the data into portions that do not exceed 2083 bytes.

Step forms a plurality of messages to communicate the divided data across domains and step communicates the plurality of messages. As previously described cross domain messages may be sent by manipulating the URL of the Iframe that is contained with a web page. For instance when the sender from a different domain wishes to communicate or send a message to an Iframe in another domain it appends the portion of the data to the appropriate Iframe s URL after the hash. In this way the portion forms a body of the message which may take the following form 

In accordance with one embodiment asynchronous communication may be utilized to communicate data across domains. Further queues may be employed by one or both sides e.g. sender and or receiver to further improve efficiency of the communication.

Step stores the plurality of messages in a queue such as in a queue that is local to a sender of the messages. Step selects one of the messages for communication across domains. For example the queue may be configured to use first in first out FIFO techniques such that the oldest message is first selected. A variety of other examples are also contemplated.

Step communicates the selected message such as through use of a server e.g. as previously described in relation to directly without use of a server as also previously described and so on.

Step determines whether an acknowledgement has been received that includes the unique identifier. For example an intended recipient of the message may strip out the unique identifier and return it in an acknowledgement to the sender to indicate that the message has been successfully received.

When the acknowledgement has not been received from step step resends the message that corresponds to the unique identifier that was not received. The sender for instance may use a time out value such that when a message in the queue has not received a corresponding acknowledgement in a specified amount of time the message is resent. A variety of other examples are also contemplated to determine when to resend a message such as by receiving an acknowledgement of a later received message.

When the acknowledgement has been received from step step removes the message from the queue that corresponds to the unique identifier. In this way the sender may clean out the queue or messages that have been successfully communicated yet messages that have not been successfully communicated may remain to be resent.

Step determines whether another message is included in the queue. If so step selects one of the messages for communication across domains as previously described. If not step finishes asynchronous communication.

There are some instances in which it is describable to employ security techniques when enabling communication across domains. For example the data to be communicated across the domains may be sensitive . In such an example techniques may be employed in which a user confirms that communication of the data is permitted before the communication occurs further discussion of which may be found in relation to . In another example a secure communication channel may be formed such as between a sender and a third party to protect against attacks by malicious parties further discussion of which may be found in relation to .

Step outputs in a user interface a portion that is selectable by the user to confirm that communication of the data is permitted. The user interface for instance may be a web browser that outputs a pop up window having a description of the data that is to be sent and one or more portions that are selectable by a user to confirm and or cancel communication of the data.

Step determines whether the user confirmed that communication is permitted. If not no from step step cancels data communication. If so yes from step step communicates the data via an Iframe.

Step shares one or more secrets across the domains. For example step provides a first secret configured as a cryptographic number from a sender to a recipient. The cryptographic number may be configured as a number that is difficult to guess based on previously generated numbers such as a random number.

Step receives a result of a function applied to the first secret and a second secret configured as a cryptographic number from the recipient. The recipient for instance may also generate a cryptographic number. A function may then be applied to the cryptographic number generated by the sender and the cryptographic number generated by the recipient which may be a function that is known or unknown by the sender.

Step forms a secure communication channel across the domains via at least one Iframe using the one or more secrets. The one or more secrets may be used as a part of the message communicated between the sender and recipient such that the sender and recipient may determine that the message originated from one of the two participants as opposed to a malicious party. For instance the result of the function applied to the first and second secrets may be used within a body of the message such that the sender and or the recipient may parse the message to locate the result. A variety of other examples are also contemplated.

Various embodiments utilize nested Iframes within a web page to allow cross domain communication. That is various embodiments can create an embedded Iframe that shares the domain of an Iframe or web page with which communication is desired. Because the embedded Iframe shares the domain of the Iframe or web page with which communication is desired restrictions on cross site scripting do not inhibit communication or scripting between the domain matched Iframe s and or web page. This embedded Iframe can then provide a mechanism by which web pages or Iframes from other domains can communicate with the Iframe or web page with which the embedded Iframe shares a domain.

Although the invention has been described in language specific to structural features and or methodological steps it is to be understood that the invention defined in the appended claims is not necessarily limited to the specific features or steps described. Rather the specific features and steps are disclosed as preferred forms of implementing the claimed invention.


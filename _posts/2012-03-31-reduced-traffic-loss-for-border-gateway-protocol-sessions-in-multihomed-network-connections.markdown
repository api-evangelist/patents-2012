---

title: Reduced traffic loss for border gateway protocol sessions in multi-homed network connections
abstract: This disclosure describes techniques to reduce traffic loss for a Border Gateway Protocol (BGP) session by delaying re-advertisement of routes received from a newly re-established multi-homed router by a primary router until all the routes are installed in a forwarding plane of the primary router. The techniques of this disclosure make use of a BGP marker received from the multi-homed router that indicates the end of a route download for an address family. Upon receiving the BGP marker, a control plane of the primary router requests a route acknowledgement message (Route-ACK) from the forwarding plane for only the last route of the address family received before the BGP marker. When the control plane receives the Route-ACK indicating that the last route has been installed in the forwarding plane, the primary router initiates re-advertisement of the routes to other BGP peer routers.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09137142&OS=09137142&RS=09137142
owner: Juniper Networks, Inc.
number: 09137142
owner_city: Sunnyvale
owner_country: US
publication_date: 20120331
---
This disclosure relates to computer networks and more particularly to multi homed connections in computer networks.

A computer network is a collection of interconnected network devices that can exchange data and share resources. Network devices within computer networks often include a control unit that provides control plane functionality and forwarding components for routing or switching data units. In some cases for example a network device may include a plurality of packet forwarding engines PFEs and a switch fabric that collectively provide a forwarding plane for forwarding network traffic. The control unit maintains routing information in a routing information base RIB that represents the overall topology of the network and defines routes to destinations within the network. The control unit derives a forwarding information base FIB that includes a number of forwarding data structures in accordance with the routing information. In some cases the control unit may install the forwarding data structures into each of the PFEs to update copies of the FIB within each of the PFEs and control traffic forwarding within the forwarding plane.

As one example of a computer network a service provider network typically provides one or more services that involve communicating data over the Internet. For customers that require high availability in accessing either the public network or other services offered by the service provider the customer may require a redundant connection to the service provider network. This redundant connection may involve coupling the customer s network device that resides at the edge of the customer network such as a customer edge CE router to a provider edge PE router of the service provider network that is different than a primary PE router to which the CE router is coupled via a primary connection. The redundant connections are typically not actively used for data transmission but may be used as a backup forwarder in the event of a network failure that would preclude the primary PE router from sending the data. As a result the primary connection may be referred to as the active connection while the redundant connection may be referred to as the non active or backup connection. Having multiple connections between the CE router and the PE routers may commonly be referred to as multi homing. 

In general this disclosure describes techniques to reduce traffic loss for Border Gateway Protocol BGP sessions by delaying re advertisement of routes received from a newly re established multi homed router at a control plane of a primary router until all the routes are installed in a forwarding plane of the primary router. In the case where the multi homed router is connected to the primary router and a backup router via a multi homed network connection traffic may continue to reach the multi homed router via backup forwarding path through the backup router during the re advertisement delay at the primary router. In this way the techniques avoid traffic loss i.e. black holing in which the primary router receives traffic on the received routes before the routes have been fully installed in the forwarding plane of the primary router.

The traffic black holing issue may be solved by implementing route acknowledgement messages Route ACKs between packet forwarding engines PFEs in the forwarding plane and a routing engine in a control plane of the primary router when each of the routes has been installed in the PFEs. Requiring Route ACKs from each of the PFEs for each of the installed routes however presents a scalability issue. The techniques of this disclosure make use of a BGP marker received from the multi homed router that indicates the end of a route download for an address family. For example upon receiving the BGP marker the primary router may request a Route ACK for only the last route of the address family received before the BGP marker. When the routing engine in the primary router receives the Route ACK indicating that the last route has been installed in the PFEs of the forwarding plane the primary router may assume that all the previous routes have also been installed in the PFEs. The receipt of the Route ACK for the last route at the routing engine of the primary router initiates re advertisement of the routes received from the multi homed router to other peer routers of the primary router.

In one example the disclosure is directed to a method comprising receiving with a primary router advertised routes from a multi homed router via a BGP session wherein the multi homed router is connected to the primary router and a backup router updating in a control plane of the primary router routing information in a routing table based on the received routes installing in a forwarding plane of the primary router forwarding data structures for the received routes in forwarding tables based on the routing information and deferring re advertisement of the routes to BGP peer routers until the control plane receives an acknowledgement from the forwarding plane indicating that a last route received from the multi homed router is installed in the forwarding tables of the forwarding plane.

In another example the disclosure is directed to a primary router in a multi homed network connection comprising interfaces configured to receive advertised routes from the multi homed router via a BGP session wherein the multi homed router is connected to the primary router and a backup router and a control unit configured to update routing information in a routing table in a control plane of the primary router based on the received routes install forwarding data structures for the received routes in forwarding tables in a forwarding plane of the primary router based on the routing information and defer re advertisement of the routes to BGP peer routers until the control plane receives an acknowledgement from the forwarding plane indicating that a last route received from the multi homed router is installed in the forwarding tables of the forwarding plane.

In a further example the disclosure is directed to a computer readable medium comprising instructions that when executed cause a processor of a primary router to receive advertised routes from a multi homed router via a BGP session wherein the multi homed router is connected to the primary router and a backup router update in a control plane of the primary router routing information in a routing table based on the received routes install in a forwarding plane of the primary router forwarding data structures for the received routes in forwarding tables based on the routing information and defer re advertisement of the routes to BGP peer routers until the control plane receives an acknowledgement from the forwarding plane indicating that a last route received from the multi homed router is installed in the forwarding tables of the forwarding plane.

The details of one or more embodiments are set forth in the accompanying drawings and the description below. Other features objects and advantages will be apparent from the description and drawings and from the claims.

The service providers may lease portions of network or provide services offering interconnection through network to customer sites which may lease the portions or purchase the services provided by network . For example network may offer a Virtual Private Network VPN service to virtually interconnect various customer network sites. A VPN may transparently interconnect customer sites to one another via service provider network . Network may provide VPN service by transparently emulating a direct connection between these various customer sites such that from the perspective of customer sites each of customer sites appears to directly connect to one another.

Customer sites may each represent a network owned and operated by a large entity such as a university corporation business or other facility or enterprise. In some instances a single large entity may own and operate two or more of customer sites . The entity may then contract with service provider network to purchase a service offered by service provider network such as VPN in order to transparently interconnect these customer sites in the manner described above.

Each of customer sites may operate according to a wide variety of network protocols such as any of the 802.3X family of network protocols related to the Ethernet protocol any of the 802.1X family of wireless networking protocols an Internet Protocol IP protocol and a Transmission Control Protocol TCP . Moreover customer sites may each comprise a Virtual Private Network VPN a Local Area Network LAN or a Wide Area Network WAN . Although not shown in the examples of for ease of illustration purposes each of customer sites may include a wide variety of interconnected computing devices or nodes such as web servers print servers application servers data servers workstations desktop computers laptop computers cellular or other mobile devices Personal Digital Assistants PDAs and any other device capable of connecting to a computer network via a wireless and or wired connection.

As shown in the example of service provider network includes provider edge PE routers A B PE routers and PE routers A C PE routers that reside at the edge of service provider network . While discussed herein with respect to a particular network device i.e. routers PE routers may each represent one example of a network device that interfaces with customer sites to route switch or otherwise forward network traffic directed to and or originating from the customer sites . The techniques may however be performed by any type of network device including a switch a hub a bridge device e.g. an Ethernet bridge or any other L network device and or L network device capable of performing L functionality. In addition while shown as physically separate network devices in the example of PE routers may reside within different chassis of what may be considered the same network device. The techniques should not therefore be limited in this respect. Additionally the techniques may be implemented with respect to different virtual network devices such as virtual PE routers that may be logically separate but executed on the same physical hardware.

PE routers may implement BGP as a control plane routing protocol to exchange routing information with peer routers located in either the same autonomous system AS e.g. service provider network or different ASs e.g. one or more of customer sites . PE outers that implement BGP may be referred to as BGP speakers. A BGP session may be established between two of PE routers configured to be peer routers. Once the session is established the BGP peers exchange routing information. For example as illustrated in each of PE routers may be BGP peers with each of PE routers . PE router A and PE router B however may not necessarily be BGP peers with each other. PE routers may comprise internal peer routers of PE routers . In addition each of PE routers may be BGP peers with CE router A in customer site A. CE router A may comprise an external peer router of PE routers . Additional details related to BGP can be found in Y. Rekhter A Border Gateway Protocol BGP 4 Request for Comments 4271 The IETF Trust January 2006 which is hereby incorporated by reference in its entirety.

Customer sites include customer edge CE routers A D CE routers respectively that reside at the edges of customer sites . While discussed herein with respect to a particular network device i.e. routers CE routers may represent any network device that interfaces with service provider network to route switch or otherwise forward network traffic directed to and or originating from network . The techniques may however be performed by any type of network device including a switch a hub a bridge device e.g. an Ethernet bridge or any other L network device and or L network device. One or more of CE routers may implement BGP as a routing protocol to exchange routing information with peer routers located in either the same AS e.g. the respective one of customer sites or different ASs e.g. service provider network . For example as illustrated in each of PE routers may be BGP peers with CE router A. CE router A may comprise an external peer router of PE routers .

In the example of customer site A has a redundant connection to service provider network through multiple PE routers A and B via respective links A and B a technique which is referred to as multi homing. Specifically customer site A via CE router A is multi homed to network through PE routers A and B. The techniques of this disclosure should not be limited to the example shown in but may be implemented with respect to any form of connectivity that involves multiple connections between two or more physical network devices such as PE routers and or virtual network devices.

There are a variety of different types of multi homed connections including an active active multi homed connection and an active standby multi home connection. In an active active multi homed connection all of the links forming the multi homed connection are considered active in that each of these links may delivery data traffic between PE routers and CE router A. In an active standby multi homed connection typically one of the links is active in delivering data traffic between PE routers and CE router A while one of the links is standby and does not delivery data traffic between PE routers and CE router A. It is assumed in this disclosure that PE routers and CE router A maintain an active standby multi homed connection although various aspects of the techniques are not limited to this form of multi homed connection and may be implemented with respect to other forms of multi homed connections such as the active active form of multi homed connection.

In the active standby link topology illustrated in one of PE routers e.g. PE router A is chosen to be the active or primary PE router i.e. designated forwarder to send traffic to and from customer site A. The other multi homing PE router e.g. PE router B is designated as a backup PE router or backup forwarder which can be used to send traffic to and from customer site A in the event of a network failure that would preclude primary PE router A from sending the traffic. In this case a primary forwarding path through network exists to send traffic from any of customer sites B D to customer site A via PE routers primary PE router A and CE router A. In addition a backup forwarding path through network exists between customer sites B D and customer site A via PE routers backup PE router B and CE router A.

In the example where the BGP session between primary PE router A and CE router A goes down PE routers will instead send traffic destined for customer site A along the backup forwarding path through backup PE router B to CE router A. When the BGP session between primary PE router A and CE router A is reestablished CE router A advertises its routes to primary PE router A. For purposes of this disclosure the term routes is generally used to describe forwarding information or forwarding data structures that are installed in a forwarding plane of a router to control traffic forwarding within the forwarding plane.

Upon receiving the route advertisements a control unit within primary PE router A updates routing information stored in a routing information base RIB that represents the overall topology of network system and defines routes to destinations within network system . After updating the RIB based on the received routes the control unit of primary PE router A derives a forwarding information base FIB that includes a number of forwarding data structures in accordance with the routing information. The control unit then updates one or more copies of the forwarding information base FIB within a forwarding plane of primary PE router A. For example the control unit of primary PE router A may install the forwarding data structures for the received routes into copies of the FIB in each of a plurality of packet forwarding engines PFEs within the forwarding plane.

Primary PE router A also re advertises the routes received from CE router A to peer PE routers in service provider network . Once primary PE router A re advertises the routes PE routers in service provider network will return to sending traffic destined for customer site A along the primary forwarding path through primary PE router A to CE router A. In some cases however primary PE router A may begin receiving data traffic from PE routers destined for customer site A before the received routes have been installed in the forwarding plane of primary PE router A. This results in traffic loss i.e. black holing at primary PE router A while the backup forwarding path exists through backup PE router B.

The techniques of this disclosure reduce traffic loss for the re established BGP session by delaying re advertisement of the routes received from CE router A at primary PE router A until all the routes are installed in the forwarding plane of primary PE router A. As illustrated in when CE router A is connected to primary PE router A and backup PE router B via a multi homed network connection traffic may continue to reach CE router A and customer site A via the backup forwarding path from PE routers through backup PE router B during the re advertisement delay at primary PE router A. In this way the techniques avoid traffic loss i.e. black holing in which primary PE router A receives traffic on the routes received from CE router A before the routes have been installed in the forwarding plane of primary PE router A.

In some cases the traffic black holing issue may also be solved by applying a constant delay to BGP re advertisements from primary PE router A to peer PE routers . The constant delay however may be too short or too long depending on the number of routes received from CE router A. Applying an appropriate length delay therefore requires user configuration at primary PE router A to adjust the delay time based on the number of routes from CE router A. In addition re advertisement delays would have to be configured separately for any routes received from other peer routers multi homed to primary PE router A. The traffic black holing issue may also be solved by implementing route acknowledgement messages Route ACKs between PFEs in the forwarding plane and a routing engine in a control plane of primary PE router A to signal when each of the routes has been installed in the PFEs. Requiring Route ACKs from each of the PFEs for each of the updated routes however presents a scalability issue.

Examples of techniques of this disclosure make use a BGP marker from multi homed CE router that indicates the end of a route download for each address family negotiated for the BGP session with primary PE router A. Conventionally the BGP marker i.e. an end of RIB marker is used during graceful failover of primary PE router A to indicate when multi homed CE router A has advertised all the routes in an address family. The number of address families negotiated for the BGP session is typically a small number e.g. less than ten. In a graceful restart situation multi homed CE router A will send an end of RIB marker for each of the address families to indicate that all the routes for the particular address family have been downloaded. The end of RIB marker may also be used when graceful restart is not enabled for the BGP session.

Upon receiving the BGP marker from CE router A indicating that a route download for a given address family is complete the routing engine of primary PE router A requests a Route ACK from the PFEs of the forwarding plane for only the last route of the address family received from CE router A before the BGP marker. When the routing engine in primary PE router A receives the Route ACK from the PFEs indicating that the last route has been installed in the PFEs primary PE router A may assume that all the previous routes have also been installed in the PFEs of the forwarding plane. The receipt of the Route ACK for the last route of the address family at the routing engine of primary PE router A initiates re advertisement of the routes received from CE router A to peer PE routers .

In this way the techniques implement an appropriate length re advertisement delay at primary PE router A to avoid traffic loss using a reduced number of Route ACKs. For example the technique may reduce a number of Route ACKs from millions to less than ten i.e. one Route ACK for each address family negotiated for the BGP session. More specifically the techniques reduce or eliminate traffic loss in a router acting as the primary router e.g. primary PE router A in a multi homed network connection when the router re advertises routes received from a newly re established multi homed router e.g. CE router A. In addition stress on the Route ACK machinery of the primary router does not increase proportional to the scale of the number of BGP routes received from the newly re established multi homed router. Instead according to the techniques the stress on the Route ACK machinery stays proportional to the number of address families negotiated for the BGP session which is typically a very small number e.g. less than ten. Further the techniques automatically adjust the re advertisement delay time based on the scale of the number of routes received from the newly re established multi homed router thus not delaying the re advertisement of routes for too long or too short of a duration of time.

In this example PE router includes control unit that provides control plane functionality for the network device. PE router also includes switch fabric interconnecting a set of line cards A N LCs each of which includes at least one of packet forwarding engines A N PFEs that send and receive traffic by a set of interface cards IFCs that typically have one or more physical network interfaces i.e. ports . LCs components included in LCs and switch fabric collectively provide a forwarding plane for forwarding transit network traffic. Although not shown in PFEs may each comprise a central processing unit CPU memory and one or more programmable packet forwarding application specific integrated circuits ASICs . Switch fabric provides a high speed interconnect for forwarding incoming data packets between PFEs for transmission over a network.

Control unit provides an operating environment for various protocols that perform control plane functions for PE router . For example daemons A N daemons comprise user level processes that run network management software execute routing protocols to communicate with peer routers maintain and update one or more routing tables and create one or more forwarding tables for installation to PFEs among other functions. For example one of daemons may use BGP as the control plane protocol for signaling a VPN service or other services offered by a service provider network e.g. network from in order to transparently interconnect customer sites connected to the network.

As another example one of daemons e.g. a routing protocol daemon RPD may run on routing engine to control L routing and L forwarding functions. In general routing engine maintains a routing information base RIB storing L routing information that defines routes to destinations within the network and L topology data that represents the overall topology of the network. Based on RIB routing engine generates forwarding information base FIB to contain forwarding data structures for installing within PFEs in the forwarding plane. As illustrated in each of PFEs include FIB which is a copy of FIB in control unit to associate network destinations with specific next hops and the corresponding interface ports within the forwarding plane.

In the example where PE router participates in a VPN service in addition to RIB control unit may store routing information in each of one or more virtual routing and forwarding VRF tables for the different VPNs supported by PE router . The routing information stored in the customer VRF tables may be leaked from a master VPN table. Only routes defined by forwarding data structures derived from the customer VRF tables are installed in FIBs of PFEs .

In the example of control unit is connected to each of LCs by a dedicated internal communication link . For example dedicated link may comprise a 200 Mbps or Gigabit Ethernet connection for internal communication between the multiple components of PE router . In one embodiment control unit communicates data representative of the software copy FIB into PFEs to program the PFEs and thereby control forwarding of traffic by the corresponding components within the forwarding plane. This allows the software copy FIB stored in memory e.g. on chip RAM in each of PFEs to be updated without degrading packet forwarding performance of PE router . In some instances control unit may derive a separate and different software FIB for each of the respective PFEs . In addition one or more of PFEs may include packet forwarding ASICs not shown in that PFEs program with a hardware copy FIB based on the software copy FIB i.e. hardware versions of the software FIBs in each of the respective PFEs .

PFEs process packets by performing a series of operations on each packet over respective internal packet forwarding paths as the packets traverse the internal architecture of PE router . Operations may be performed for example on each packet by any of a corresponding ingress interface an ingress one of PFEs an egress one of PFEs an egress interface or other components of PE router to which the packet is directed prior to egress. PFEs each include forwarding data structures within FIB that when executed examine the contents of each packet and on that basis make forwarding decisions apply filters and or perform accounting management traffic analysis and load balancing for example. The result of packet processing determines the manner in which a packet is forwarded or otherwise processed by PFEs from its ingress interface on one of IFCs to its egress interface on one of IFCs .

Daemons identify individual programs stored in control unit for compilation and instantiation as forwarding data structures in FIBs in order to apply functions designated by daemons for the forwarding plane functionality of PE router . The programs may specify functions to be performed on the packet including fundamental packet forwarding operations such as input packet processing route lookup and output packet processing as well as service functions such as packet filtering or access control statistical sampling traffic policing rate limiting and accounting. For example one of daemons may execute BGP and receive a message from a BGP peer that causes the daemon to trigger a particular BGP function defined by one of the programs. As another example one of daemons may execute a command line interface CLI that receives from a user a command to apply a policing function that is defined by one of the programs to rate limit a particular traffic flow at a particular rate.

Daemons then invoke FIB interface to select the appropriate forwarding data structure of the programs for installation to PFEs in FIBs . FIB interface presents an interface to PFEs by which daemons may communicate one or more forwarding data structures via internal communication link for instantiation within FIBs to establish packet forwarding paths and provide lookup data. FIB interface may comprise one or more user or kernel level libraries programs toolkits application programming interfaces APIs . Additional information regarding packet forwarding path programming is available in PACKET FORWARDING PATH PROGRAMMING USING A HIGH LEVEL DESCRIPTION LANGUAGE U.S. application Ser. No. 13 194 571 filed Jul. 29 2011 which is incorporated herein by reference in its entirety.

The operating environment of control unit may be implemented solely in software or hardware or may be implemented as a combination of software hardware or firmware. For example control unit may include one or more processors which execute software instructions. In that case control unit may include various software modules or daemons e.g. daemons executing on an operating system and may include a non transitory computer readable storage device such as computer memory or hard disk for storing executable instructions.

The architecture of PE router illustrated in is shown for exemplary purposes only. The disclosure is not limited to this architecture. In other embodiments PE router may be configured in a variety of ways. In one embodiment for example some of the functionally of control unit may be distributed within PFEs . Elements of control unit may be implemented solely in software or hardware or may be implemented as combinations of software hardware or firmware. For example control unit may include one or more processors one or more microprocessors digital signal processors DSPs application specific integrated circuits ASICs field programmable gate arrays FPGAs or any other equivalent integrated or discrete logic circuitry or any combination thereof which execute software instructions. In that case the various software modules of control unit may comprise executable instructions stored embodied or encoded in a computer readable medium such as a computer readable storage medium containing instructions. Instructions embedded or encoded in a computer readable medium may cause a programmable processor or other processor to perform the method e.g. when the instructions are executed.

Computer readable storage media may include random access memory RAM read only memory ROM programmable read only memory PROM erasable programmable read only memory EPROM electronically erasable programmable read only memory EEPROM non volatile random access memory NVRAM flash memory a hard disk a CD ROM a floppy disk a cassette a solid state drive magnetic media optical media or other computer readable media. Computer readable media may be encoded with instructions corresponding to various aspects of PE router e.g. protocols. Control unit in some examples retrieves and executes the instructions from memory for these aspects.

As described above PE router may comprise a primary router in a multi homed network connection. For example control unit of primary PE router may execute BGP to maintain a BGP session with a multi homed router. In this case primary PE router operates as the designated forwarder to send traffic on a primary forwarding path to the multi homed router. Another PE router connected to the multi homed router may operate as a backup router. When the BGP session between primary PE router and the multi homed router is down the backup router will be used to send traffic on a backup forwarding path to the multi homed router. Once the BGP session between primary PE router and the multi homed router is reestablished PE router reestablishes the primary forwarding path to the multi homed router from other BGP peers of PE router .

After the BGP session with primary PE router is reestablished PE router receives route advertisements for one or more BGP address families from the multi homed router. Upon receiving the route advertisements control unit of PE router executes routing engine to update the routing information stored in RIB . After updating RIB based on the received routes routing engine updates forwarding information including forwarding data structures stored in FIB based on the routing information in updated RIB . Control unit then updates FIBs within PFEs in the forwarding plane of PE router based on the changes to FIB . As described above daemons invoke FIB interface to install appropriate forwarding data structures into FIBs of PFEs . In this way packet forwarding paths through the forwarding plane of PE router are reestablished for the received network routes to the multi homed router.

Conventionally immediately upon receiving the advertised routes control unit of PE router may execute BGP to re advertise the received routes to BGP peers in the network to reestablish the primary forwarding path. Once the routes are re advertised the BGP peer routers will begin sending traffic destined for the multi homed router along the primary forwarding path through PE router . This immediate re advertisement however may result in traffic loss i.e. black holing when PE router receives traffic on the received routes before the routes have been installed in the forwarding plane of PE router . In the case of the multi homed network connection this traffic loss is avoidable because the traffic can continue to be forwarded to the multi homed router on the backup forwarding path while the primary forwarding path is still being programmed.

According to the techniques of this disclosure control unit executes BGP with a deferred advertisement extension that defers re advertisement of the routes received in an address family to the BGP peers in the network until a last route of the address family for the BGP session is installed in the forwarding plane of PE router . By deferring the route re advertisement until the last route is installed in the forwarding plane control unit ensures that all the received routes are installed in the forwarding plane of PE router before receiving traffic destined for the multi homed router on the received routes. During the deferred router re advertisement traffic may continue to be sent to the multi homed router via the backup forwarding path. In this way the techniques eliminate or reduce traffic loss for a BGP session due to black holing in a multi homed network connection.

In order to achieve an appropriate length re advertisement delay and maintain scalability the techniques utilize a BGP marker received from the multi homed router that indicates the end of a route download for a given address family. Specifically upon receiving the BGP marker i.e. an end of RIB marker from the multi homed router indicating that a route download for the address family is complete routing engine of PE router requests a Route ACK from PFEs in the forwarding plane for only the last route received from the multi homed router before the BGP marker. In this way routing engine will receive an acknowledgement when the last route for the address family has been installed in PFEs of the forwarding plane. Routing engine may assume that by the time the last route has been installed in PFEs all the routes in the address family received previous to the last route have also been installed in PFEs .

In the example where PE router participates in a VPN service and maintains one or more VRF tables for the different VPNs only routes defined by forwarding data structures derived from a customer VRF table are installed in FIBs of PFEs . In this case routing engine may request Route ACKs only for routes of the customer VRF table that will be installed in FIBs . Routing engine therefore requests a Route ACK for the last route of an address family that is also included in the customer VRF table and will be installed in FIBs in the forwarding plane.

The receipt of the Route ACK for the last route of the address family triggers re advertisement of all the routes of the address family received from the multi homed router to BGP peers in the network. In this way the techniques reduce or eliminate traffic loss for a BGP session between primary PE router and a newly re established multi homed router while using a minimum number of Route ACK messages. In some cases as a fallback measure the wait time for routing engine to receive the Route ACK for the last route from the PFEs may time out after a reasonable duration of time. In this case the time out may trigger the route re advertisement.

In the illustrated example control unit provides a control plane operating environment for execution of various user level daemons in user space . Daemons in this example include command line interface daemon CLI routing protocol daemon RPD and Simple Network Management Protocol daemon SNMP . In other examples control unit may include additional daemons not shown in that perform other control management or service plane functionality and or drive and otherwise manage data plane functionality for PE router .

RPD executes one or more interior and or exterior routing protocols to exchange routing information with other network devices store received routing information in RIB and store derived forwarding information in FIB . CLI provides a shell by which an administrator or other management entity may modify the configuration of PE router using text based commands. SNMP comprises an SNMP agent that receives SNMP commands from a management entity to set and retrieve configuration and management information for PE router . RPD CLI and SNMP configure the forwarding plane to implement packet forwarding services add modify delete routes and otherwise modify packet forwarding paths by installing forwarding structures in FIBs of PFEs .

Daemons operate over and interact with kernel which provides a run time operating environment for user level processes. Kernel may comprise for example a UNIX operating system derivative such as Linux or Berkeley Software Distribution BSD . Kernel offers libraries and drivers by which daemons may interact with the underlying system. PFE interface of kernel comprises a kernel level library by which daemons FIB interface and other user level processes or user level libraries may interact with PFEs . PFE interface may include for example a sockets library for communicating with PFEs over dedicated network links.

Hardware environment of control unit includes microprocessor that executes program instructions in order to execute both kernel and user space of control unit . Microprocessor may comprise one or more general or special purpose processors such as a digital signal processor DSP an application specific integrated circuit ASIC a field programmable gate array FPGA or any other equivalent logic device. Accordingly the terms processor or controller as used herein may refer to any one or more of the foregoing structures or any other structure operable to perform techniques described herein.

As described above with respect to FIB interface allows daemons to drive the installation and configuration of forwarding data structures in PFEs . In particular FIB interface includes an API by which daemons may select an appropriate forwarding data structure for installation to PFEs and communicate the forwarding data structure to PFEs for installation to FIBs as packet forwarding paths.

PFEs implement forwarding plane functionality to handle packet processing from ingress interfaces on which packets are received to egress interfaces to which packets are sent. The forwarding plane determines data packet forwarding through PE router applies packet forwarding services rate limits packet flows filters packets and otherwise processes the packets using forwarding data structures and lookup data installed by control unit in PFEs . While illustrates only PFE A in detail each of PFEs comprises similar components that perform substantially similar functionality.

The forwarding data structures define a forwarding path for each incoming packet received by PE router . For example a route table lookup forwarding data structure maps packet properties e.g. destination information and other select information from a packet header to one or more specific next hop routers and to one or more specific output interfaces based on route information. Forwarding path may include for example executable instructions programmable logic and application specific logic that perform lookups rate limit packet flows and other functions defined by the forwarding data structures. PFE A includes ASICs that process packets to identify packet properties and perform actions associated with the properties. Forwarding path comprises programmable executable microcode and fixed hardware components that determine the packet processing actions and other operations performed by ASICs .

PFE microprocessor manages ASICs and executes FIB PFE interface to provide an interface to control unit . PFE microprocessor may execute a microkernel to provide an operating environment for interfaces. FIB PFE interface is a programming interface that receives forwarding data structures from PFE interface of control unit . The forwarding data structures are then installed in FIB A in ASIC as a portion of forwarding path .

As described above PE router may comprise a primary router in a multi homed network connection that operates as the designated forwarder to send traffic on a primary forwarding path to the multi homed router. Another PE router connected to the multi homed router may operate as a backup router. After a failure of a BGP session between primary PE router and the multi homed router traffic may be sent on a backup forwarding path to the multi homed router until the primary forwarding path is reestablished. Once the BGP session between primary PE router and the multi homed router is reestablished PE router reestablishes the primary forwarding path to the multi homed router by re advertising routes of the multi homed router to other BGP peers of PE router .

The techniques of this disclosure reduce traffic loss for the BGP session between primary PE router and the newly re established multi homed router by delaying reestablishment of the primary forwarding path until all the routes are updated in the forwarding plane of primary PE router . In order to delay reestablishment of the primary forwarding path control unit of PE router defers re advertising the routes received from the multi homed router to the other BGP peers until a last route for a given address family is installed in the forwarding plane of PE router .

As described above with respect to the techniques utilize a BGP marker i.e. an end of RIB marker received from the multi homed router that indicates the end of a route download for a given address family. In response to receiving the BGP marker RPD triggers a Route ACK for only the last route of the address family by using a route change mechanism. For example when control unit receives the BGP marker from the multi homed router RPD executing in control unit locates the last route installed in RIB and issues a route change request with a set Route ACK bit. In this way RPD directs a Route ACK flag to set on the last route in RIB . The Route ACK flag indicates that PFEs will send a Route ACK for the last route to control unit once the route installation in the forwarding plane is complete. The deferred advertisement extension of BGP protocol remembers that a Route ACK has been requested for the last route in an address family and delays re advertisement of the address family routes to other BGP peers until the last route is updated in the forwarding plane. The techniques of this disclosure utilize the end of RIB marker to identify the last route received for an address family in RIB and defer re advertisement of all the routes of the address family until the last route is installed in the forwarding plane.

RPD uses FIB interface to send the route change request to PFE interface in kernel for communication to PFEs . Kernel generates a request for a Route ACK for the last route of the address family to all PFEs in the forwarding plane. Once the last route is installed in FIBs of PFEs via FIB PFE interface each of PFEs sends a Route ACK response back to kernel via FIB PFE interface and PFE interface . Kernel then consolidates the Route ACK responses from all PFEs and provides a single consolidated Route ACK response to RPD indicating that the route has been updated in all PFEs of the forwarding plane.

When kernel generates the Route ACK request for the last route kernel also generates a Route ACK cookie for the routing engine. RPD maintains a Route ACK table in control unit that maintains a mapping between the route and the Route ACK cookie until the consolidated Route ACK response is received from kernel . When RPD receives the Route ACK response from kernel an updated route change is indicated for the route associated with the Route ACK cookie. RPD looks up the route associated with the Route ACK cookie in route ACK table locates the route in RIB and clears the Route ACK flag set on the route in RIB . Once the Route ACK flag is cleared for the last route in RIB RPD knows that the last route for the address family is installed in PFEs . RPD may then assume that all the routes in the address family received previous to the last route have also been installed in PFEs . The receipt of the Route ACK and clearing of the Route ACK flag for the last route of the address family triggers re advertisement of the routes for the address family to the BGP peers in the network.

As described above in the active standby link topology illustrated in primary PE router A is the designated forwarder to send traffic to and from customer site A. The other backup PE router B is the backup forwarder which can be used to send traffic to and from customer site A in the event of a network failure that would preclude primary PE router A from sending the traffic. In this case a primary forwarding path through network exists to send traffic from any of customer sites B D to customer site A via PE routers primary PE router A and CE router A. In addition a backup forwarding path through network exists between customer sites B D and customer site A via PE routers backup PE router B and CE router A.

When the BGP session between primary PE router A and CE router A goes down multi homed CE router A receives traffic for customer site A via the backup forwarding path through backup PE router B . Multi homed CE router A then reestablishes the BGP session with primary PE router . Once the BGP session is reestablished multi homed CE router A advertises its routes to primary PE router A .

Primary PE router A receives the routes advertised by multi homed CE router A . Upon receiving the advertised routes a control unit within primary PE router A updates routing information stored in a RIB based on the received routes . The control unit of primary PE router A also derives a FIB that includes a number of forwarding data structures in accordance with the routing information in the updated RIB. According to the techniques of this disclosure primary PE router A defers re advertisement of the routes to its BGP peers e.g. PE routers in service provider network . If primary PE router A immediately re advertises the routes primary PE router A may begin receiving data traffic destined for multi homed CE router A of customer site A before the received routes have been installed in the forwarding plane of primary PE router A. This results in traffic loss i.e. black holing at primary PE router A. By deferring the route re advertisement the data traffic may continue to be sent over the backup forwarding path until the routes are updated in the forwarding plane of primary PE router A.

After the RIB and FIB are updated in the control plane the control unit of primary PE router A then installs the routes in copies of FIBs within the forwarding plane of primary PE router A based on the updated RIB in the control plane . For example the control unit of primary PE router A may install forwarding data structures for the routes into copies of FIBs in the PFEs of the forwarding plane in PE router A.

Once multi homed CE router A advertises the last route for a given address family multi homed CE router A sends a BGP marker to primary PE router A indicating the end of the route download for the address family . Primary PE router A receives the BGP marker e.g. an end of RIB marker indicating the end of the route download for the address family . Upon receiving the BGP marker the routing engine of primary PE router A requests a Route ACK from the forwarding plane for only the last route of the address family received from multi homed CE router A before the BGP marker .

In accordance with the techniques of this disclosure the routing engine of primary PE router A triggers a Route ACK for only the last route of the address family by using a route change mechanism. For example when the routing engine of primary PE router A receives the BGP marker from multi homed CE router A the routing engine of primary PE router A locates the last route installed in the RIB and issues a route change with a Route ACK bit set. In this way a Route ACK flag will be set on the last route in the RIB indicating that PFEs will send a Route ACK for the route to the control unit before re advertising the route. The route change request is then sent to the kernel of primary PE router A and the kernel generates the request for the Route ACK for the last route to all the PFEs in the forwarding plane.

The routing engine of primary PE router A then receives the Route ACK from the forwarding plane once the last route of the address family has been installed in the forwarding plane . For example the kernel consolidates the responses from all the PFEs in the forwarding plane and provides a single consolidated Route ACK indicating that the last route has been installed in all the PFEs of the forwarding plane. When the kernel requests a Route ACK the kernel also generates a Route ACK cookie for the routing engine. The routing engine maintains a mapping between the route and the Route ACK cookie until the consolidated Route ACK is received from the kernel. When the routing engine receives the Route ACK from the kernel an updated route change is indicated for the last route. The routing engine determines the last route using the Route ACK cookie locates the last route in the RIB and clears the Route ACK flag associated with the last route in the RIB.

Once the last route has been installed in the forwarding plane the control unit of primary PE router A may assume that all the previous routes of the address family have also been installed in the forwarding plane. Upon receiving the Route ACK for the last route primary PE router A re advertises the routes to peer PE routers to reestablish the primary forwarding path through network . In some cases as a fallback measure the wait time for the routing engine to receive a Route ACK from the forwarding plane may time out after a reasonable duration of time and the time out may trigger the route re advertisement.

According to the techniques primary PE router A receives data traffic destined for multi homed CE router A of customer site A only after the received routes have been installed in the forwarding plane of primary PE router A. Multi homed CE router A then receives the traffic via the primary forwarding path through primary PE router A . In this way the techniques reduce or eliminate traffic loss at primary PE router A when the router re advertises routes received from a newly re established BGP peer e.g. CE router A.

Various embodiments have been described. These and other embodiments are within the scope of the following claims.

